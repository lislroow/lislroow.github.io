<!DOCTYPE html>
<html lang="ko-kr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MEMO</title>
  <meta name="author" content="lislroow@daum.net">
  <meta name="description" content="KIM MYEONGGU&#39;s MEMO site">
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/highlight/prism.css">
  <script src="/highlight/prism.js"></script>
</head>
<body>
  <header>
  <div class="navbar">
    <a href="https://lislroow.github.io/">MEMO</a>
    
    
      
      <div class="dropdown">
        <button class="dropbtn">&#43; archive</button>
        <div class="dropdown-content">
        
          <a href="/archive/apache/">apache</a>
        
          <a href="/archive/nginx/">nginx</a>
        
          <a href="/archive/oracle19c/">oracle19c</a>
        
          <a href="/archive/others/">others</a>
        
        </div>
      </div>
      
    
      
      <div class="dropdown">
        <button class="dropbtn">&#43; shell</button>
        <div class="dropdown-content">
        
          <a href="/shell/bash/">bash</a>
        
          <a href="/shell/docker/">docker</a>
        
        </div>
      </div>
      
    
    
    
    <a href="#" id="toggleTocButton" style="margin-left: auto;">+</a>
    <script>
    document.getElementById('toggleTocButton').addEventListener('click', function() {
      document.querySelector('.aside').classList.toggle('hidden');
    });
    </script>
  </div>
</header>

  
<main class="container">
  <div class="main-content">
    <div class="content">
      <article>
        <h1></h1>
        <div>
          <h4 id="3-forward-proxy-test">3. forward proxy test</h4>
<h5 id="2-spring-app-구성">2) spring app 구성</h5>
<ul>
<li><code>script.sh --build</code> 을 build 수행 후 <code>script --run</code> 으로 docker 컨테이너 실행</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VAR</span>
</span></span><span style="display:flex;"><span>CURRDIR<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span> pwd -P <span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>APPNAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>basename $CURRDIR<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>DOCKER_REGISTRY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;172.28.200.40:5000&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># //VAR</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># usage</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> USAGE <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  cat <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- USAGE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Usage: ${0##*/} &lt;option&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> --build         : 전체 빌드 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> --build-java    : maven 빌드 실행
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> --build-docker  : docker 이미지 빌드 실행
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> --run           : docker 실행
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># //usage</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># options</span>
</span></span><span style="display:flex;"><span>OPTIONS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;h&#34;</span>
</span></span><span style="display:flex;"><span>LONGOPTIONS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;help,build,build-app,build-docker,run&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> SetOptions <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  opts<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span> getopt --options $OPTIONS <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --longoptions $LONGOPTIONS <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 -- $* <span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>  eval set -- $opts
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $1 <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>      break
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> $1 in
</span></span><span style="display:flex;"><span>      -h | --help<span style="color:#f92672">)</span> ;;
</span></span><span style="display:flex;"><span>      --build<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TASKS<span style="color:#f92672">=(</span><span style="color:#e6db74">&#39;build-java&#39;</span> <span style="color:#e6db74">&#39;build-docker&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>      --build-java<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TASKS<span style="color:#f92672">=(</span><span style="color:#e6db74">&#39;build-java&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>      --build-docker<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TASKS<span style="color:#f92672">=(</span><span style="color:#e6db74">&#39;build-docker&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>      --run<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TASKS<span style="color:#f92672">=(</span><span style="color:#e6db74">&#39;run&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>      --<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>      *<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        params<span style="color:#f92672">+=(</span>$1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">esac</span>
</span></span><span style="display:flex;"><span>    shift
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>SetOptions $*
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? -ne <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  USAGE
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># //options</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># main</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> main <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> task in <span style="color:#e6db74">${</span>TASKS[*]<span style="color:#e6db74">}</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;task: </span>$task<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>task<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> in
</span></span><span style="display:flex;"><span>      build-java<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        mvn clean package
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? -ne <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>          echo <span style="color:#e6db74">&#34;build failed&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          echo <span style="color:#e6db74">&#34;successful build&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>      build-docker<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        docker build -t <span style="color:#e6db74">${</span>DOCKER_REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span> .
</span></span><span style="display:flex;"><span>        docker login <span style="color:#e6db74">${</span>DOCKER_REGISTRY<span style="color:#e6db74">}</span> -u admin -p <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        docker push <span style="color:#e6db74">${</span>DOCKER_REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>        docker rmi <span style="color:#e6db74">${</span>DOCKER_REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>      run<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        docker pull <span style="color:#e6db74">${</span>DOCKER_REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>        ID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>docker ps -a --filter <span style="color:#e6db74">&#34;name=</span><span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --format <span style="color:#e6db74">&#34;{{.ID}}&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -z <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>          docker stop <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>          docker rm <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        docker run -itd <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -e JAVA_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-Dspring.profiles.active=prod -Xms256m -Xmx256m -XX:MetaspaceSize=192m -XX:MaxMetaspaceSize=192m&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          --network<span style="color:#f92672">=</span>host <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          --name<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          <span style="color:#e6db74">${</span>DOCKER_REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">esac</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>main
</span></span><span style="display:flex;"><span><span style="color:#75715e"># //main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exit <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><h5 id="1-nginx-설정">1) nginx 설정</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ apt-get install nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt; EOF &gt; /etc/nginx/sites-available/egress-proxy.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  listen   15200;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  server_name  localhost;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  location / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    proxy_pass http://172.28.200.1:8083;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    proxy_set_header Host \$host;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    proxy_set_header X-Real-IP \$remote_addr;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    proxy_set_header X-Forwarded-Proto \$scheme;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ln -s /etc/nginx/sites-available/egress-proxy.conf /etc/nginx/sites-enabled/egress-proxy.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl restart nginx
</span></span></code></pre></div><h4 id="2-sample-app-test">2. sample app test</h4>
<h5 id="3-scripts">3) scripts</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cnameList<span style="color:#f92672">=(</span><span style="color:#66d9ef">$(</span>docker ps --format <span style="color:#e6db74">&#34;{{.Names}}&#34;</span><span style="color:#66d9ef">)</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>midx<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>mtot<span style="color:#f92672">=</span><span style="color:#e6db74">${#</span>cnameList[*]<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> cname in <span style="color:#e6db74">${</span>cnameList[*]<span style="color:#e6db74">}</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  cpid<span style="color:#f92672">=(</span><span style="color:#66d9ef">$(</span>docker inspect --format <span style="color:#e6db74">&#39;{{.State.Pid}}&#39;</span> <span style="color:#e6db74">${</span>cname<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  cport<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>netstat -ntpl | grep <span style="color:#e6db74">${</span>cpid<span style="color:#e6db74">}</span> | awk <span style="color:#e6db74">&#39;{ gsub(&#34;:::&#34;, &#34;&#34;, $4); print $4 }&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -z <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>cport<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    cport<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>docker inspect --format <span style="color:#e6db74">&#39;{{.HostConfig.PortBindings}}&#39;</span> <span style="color:#e6db74">${</span>cname<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>  ccmd<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>docker inspect --format <span style="color:#e6db74">&#39;{{.Config.Cmd}}&#39;</span> <span style="color:#e6db74">${</span>cname<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>cport<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ccmd<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;null&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;# [</span><span style="color:#e6db74">${</span>midx<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>mtot<span style="color:#e6db74">}</span><span style="color:#e6db74">] </span><span style="color:#e6db74">${</span>cname<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;  - pid: </span><span style="color:#e6db74">${</span>cpid<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;  - listen port: </span><span style="color:#e6db74">${</span>cport<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;  - command: </span><span style="color:#e6db74">${</span>ccmd<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>  let <span style="color:#e6db74">&#34;midx = midx + 1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><h5 id="2-docker-build">2) docker build</h5>
<ul>
<li><code>Dockerfile</code> 설정</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-docker" data-lang="docker"><span style="display:flex;"><span>cat &lt;&lt; EOF &gt; images/java-app/Dockerfile<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> localhost:5000/amazoncorretto:8-alpine-jdk-with-curl</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /service</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./target/*.jar /service<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;java \${JAVA_OPTS} -jar *.jar&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>EOF<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><ul>
<li>docker build</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>BASEPATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;images&#34;</span>
</span></span><span style="display:flex;"><span>APPNAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;java-app&#34;</span>
</span></span><span style="display:flex;"><span>REGISTRY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;localhost:5000&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker build -t <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>BASEPATH<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>docker image list
</span></span><span style="display:flex;"><span>docker login <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span> -u admin -p <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>docker push <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>docker rmi <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span></code></pre></div><ul>
<li>docker run</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>APPNAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;java-app&#34;</span>
</span></span><span style="display:flex;"><span>REGISTRY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;localhost:5000&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker pull <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>ID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>docker ps -a --filter <span style="color:#e6db74">&#34;name=java-app&#34;</span> --format <span style="color:#e6db74">&#34;{{.ID}}&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -z <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  docker stop <span style="color:#e6db74">&#34;java-app&#34;</span>
</span></span><span style="display:flex;"><span>  docker rm <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>docker run -itd -e JAVA_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-Xms256g -Xmx256g -XX:MetaspaceSize=192M -XX:MaxMetaspaceSize=192M&#34;</span> --network<span style="color:#f92672">=</span>host --name<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#docker run -itd -p 8080:8080 --name=${APPNAME} ${REGISTRY}/${APPNAME}</span>
</span></span></code></pre></div><h5 id="1-java-build">1) java build</h5>
<ul>
<li>java, maven 설치</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apt-get install maven
</span></span><span style="display:flex;"><span>apt-get install openjdk-8-jdk
</span></span><span style="display:flex;"><span>update-alternatives --set java /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java
</span></span><span style="display:flex;"><span><span style="color:#75715e">#update-alternatives --set java /usr/lib/jvm/java-11-openjdk-amd64/bin/java</span>
</span></span><span style="display:flex;"><span>JAVA_HOME<span style="color:#f92672">=</span>/usr/lib/jvm/java-8-openjdk-amd64/jre
</span></span></code></pre></div><ul>
<li>maven 프로젝트 소스 생성</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>mkdir -p images/java-app
</span></span><span style="display:flex;"><span>cat <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#f92672">&lt; EOF</span> <span style="color:#f92672">&gt;</span> images/java-app/pom.xml
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;project</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> <span style="color:#a6e22e">xsi:schemaLocation=</span><span style="color:#e6db74">&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;modelVersion&gt;</span>4.0.0<span style="color:#f92672">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;groupId&gt;</span>mgkim<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;artifactId&gt;</span>java-app<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;version&gt;</span>0.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;java.version&gt;</span>8<span style="color:#f92672">&lt;/java.version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;maven.compiler.target&gt;</span>8<span style="color:#f92672">&lt;/maven.compiler.target&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;maven.compiler.source&gt;</span>8<span style="color:#f92672">&lt;/maven.compiler.source&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-dependencies<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>2.7.18<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;type&gt;</span>pom<span style="color:#f92672">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;scope&gt;</span>import<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;defaultGoal&gt;</span>compile<span style="color:#f92672">&lt;/defaultGoal&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>2.7.18<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;id&gt;</span>default-package<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;phase&gt;</span>package<span style="color:#f92672">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">&lt;goal&gt;</span>repackage<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/project&gt;</span>
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>mkdir <span style="color:#f92672">-</span>p images<span style="color:#f92672">/</span>java<span style="color:#f92672">-</span>app<span style="color:#f92672">/</span>src<span style="color:#f92672">/</span>main<span style="color:#f92672">/</span>java
</span></span><span style="display:flex;"><span>cat <span style="color:#f92672">&lt;&lt;</span> EOF <span style="color:#f92672">&gt;</span> images<span style="color:#f92672">/</span>java<span style="color:#f92672">-</span>app<span style="color:#f92672">/</span>src<span style="color:#f92672">/</span>main<span style="color:#f92672">/</span>java<span style="color:#f92672">/</span>MainApplication.<span style="color:#a6e22e">java</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> app;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MainApplication</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>    SpringApplication.<span style="color:#a6e22e">run</span>(MainApplication.<span style="color:#a6e22e">class</span>, args);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><ul>
<li>maven 빌드 및 java 실행</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mvn package -f images/java-app/pom.xml
</span></span><span style="display:flex;"><span>java -jar images/java-app/target/java-app*.jar
</span></span></code></pre></div><h4 id="1-docker-환경-구성-ubuntu22">1. docker 환경 구성 (ubuntu22)</h4>
<ul>
<li>구성 편의를 위해 아래 규칙으로 작업</li>
<li>모든 프로세스는 root 계정으로 설정</li>
<li>https 설정 최소화</li>
</ul>
<h5 id="1-nexus-구성">1) &rsquo;nexus&rsquo; 구성</h5>
<ul>
<li>파일: /opt/docker-compose/nexus.yml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>services:
</span></span><span style="display:flex;"><span>  nexus:
</span></span><span style="display:flex;"><span>    image: sonatype/nexus3:latest
</span></span><span style="display:flex;"><span>    container_name: nexus
</span></span><span style="display:flex;"><span>    ports:
</span></span><span style="display:flex;"><span>      - 9100:8081
</span></span><span style="display:flex;"><span>    restart: always
</span></span><span style="display:flex;"><span>    user: &#34;root:root&#34;
</span></span><span style="display:flex;"><span>    volumes:
</span></span><span style="display:flex;"><span>      - nexus_data:/nexus-data
</span></span></code></pre></div><ul>
<li>admin 계정 로그인
<code>docker exec nexus bash -c 'cat /nexus-data/admin.password'</code></li>
<li>repositories &lsquo;docker-hosted&rsquo; 생성
<code>http: 5000 (입력)</code>, <code>Enable Docker V1 API (체크)</code></li>
<li>realms &lsquo;Docker Bearer Token Realm&rsquo; 추가</li>
<li>daemon.json 항목 추가
<ul>
<li>docker 이미지를 생성할 때 dns lookup 을 할 수 있도록 설정 추가</li>
<li>원격 api 요청 수신 설정</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>cat <span style="color:#f92672">&lt;&lt;</span> EOF <span style="color:#f92672">&gt;</span> <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>docker<span style="color:#f92672">/</span>daemon<span style="color:#f92672">.</span>json
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;insecure-registries&#34;</span>: [<span style="color:#e6db74">&#34;localhost:5000&#34;</span>],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;dns&#34;</span>: [<span style="color:#e6db74">&#34;8.8.8.8&#34;</span>, <span style="color:#e6db74">&#34;8.8.4.4&#34;</span>],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;hosts&#34;</span>: [<span style="color:#e6db74">&#34;tcp://0.0.0.0:2375&#34;</span>, <span style="color:#e6db74">&#34;unix:///var/run/docker.sock&#34;</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><ul>
<li>
<p>systemctl restart docker</p>
</li>
<li>
<p>docker login http://localhost:5000</p>
</li>
<li>
<p>인증정보</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>cat &lt;&lt; EOF &gt; ~/.docker/config.json
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;auths&#34;: {
</span></span><span style="display:flex;"><span>    &#34;localhost:5000&#34;: {
</span></span><span style="display:flex;"><span>      &#34;auth&#34;: &#34;YWRtaW46c2tkaSwsMTIz&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><h5 id="2-docker-이미지-push">2) docker 이미지 push</h5>
<ul>
<li>jdk 이미지 생성</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p images/jdk
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF &gt; images/jdk/Dockerfile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FROM amazoncorretto:8-alpine-jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RUN apk --no-cache add curl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>APPNAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;amazoncorretto:8-alpine-jdk-with-curl&#34;</span>
</span></span><span style="display:flex;"><span>REGISTRY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;localhost:5000&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker build -t <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span> images/jdk
</span></span><span style="display:flex;"><span>docker image list
</span></span><span style="display:flex;"><span>docker login <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span> -u admin -p <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>docker push <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>docker rmi <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span></code></pre></div><ul>
<li>java-app(java application) 이미지 생성</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p images/java-app
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF &gt; images/java-app/Dockerfile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FROM localhost:5000/amazoncorretto:8-alpine-jdk-with-curl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ENTRYPOINT [&#34;/bin/sh&#34;, &#34;-c&#34;, &#34;which curl&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>APPNAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;java-app&#34;</span>
</span></span><span style="display:flex;"><span>REGISTRY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;localhost:5000&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker build -t <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span> images/java-app
</span></span><span style="display:flex;"><span>docker image list
</span></span><span style="display:flex;"><span>docker login <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span> -u admin -p <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>docker push <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>docker rmi <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span></code></pre></div><h5 id="3-java-app-컨테이너-실행">3) java-app 컨테이너 실행</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>APPNAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;java-app&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker pull <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>docker run -itd --network<span style="color:#f92672">=</span>host --name<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>REGISTRY<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APPNAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 컨테이너 명령어</span>
</span></span><span style="display:flex;"><span>docker stop $container_name
</span></span><span style="display:flex;"><span>docker kill $container_name
</span></span><span style="display:flex;"><span>docker rm $container_name
</span></span><span style="display:flex;"><span>docker logs $container_name
</span></span><span style="display:flex;"><span>docker logs -f $container_name
</span></span><span style="display:flex;"><span>docker logs --tail <span style="color:#ae81ff">50</span> $container_name
</span></span><span style="display:flex;"><span>docker logs -t $container_name
</span></span></code></pre></div><h4 id="docker-설치-ubuntu22">docker 설치 (ubuntu22)</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
</span></span><span style="display:flex;"><span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
</span></span><span style="display:flex;"><span>add-apt-repository <span style="color:#e6db74">&#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span style="color:#66d9ef">$(</span>lsb_release -cs<span style="color:#66d9ef">)</span><span style="color:#e6db74"> stable&#34;</span>
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install docker-ce docker-ce-cli containerd.io
</span></span></code></pre></div><h4 id="docker-host-설정">docker host 설정</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>/usr/lib/systemd/system/docker.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/bin/dockerd --containerd<span style="color:#f92672">=</span>/run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF &gt; /etc/docker/daemon.json
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ... ,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;hosts&#34;: [&#34;tcp://0.0.0.0:2375&#34;, &#34;unix:///var/run/docker.sock&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h4 id="locale">locale</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apt install locales
</span></span><span style="display:flex;"><span>vi /etc/locale.gen
</span></span><span style="display:flex;"><span>locale-gen 
</span></span><span style="display:flex;"><span>locale -a
</span></span><span style="display:flex;"><span>cat /etc/default/locale
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF &gt; /etc/default/locale
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LANG=ko_KR.utf8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>timedatectl set-timezone Asia/Seoul
</span></span><span style="display:flex;"><span>timedatectl
</span></span></code></pre></div><h4 id="ufw-방화벽">ufw: 방화벽</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl disable --now ufw
</span></span></code></pre></div><h4 id="network">network</h4>
<p>파일: /etc/netplan/00-installer-config.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">network</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ethernets</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">eth0</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">172.28.200.40</span><span style="color:#ae81ff">/24</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nameservers</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">8.8.8.8</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">search</span>: []
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">to</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">via</span>: <span style="color:#ae81ff">172.28.200.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">2</span>
</span></span></code></pre></div>
        </div>
      </article>
    </div>
  </div>
  <aside class="aside">



<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li><a href="#3-forward-proxy-test">3. forward proxy test</a>
                  <ul>
                    <li><a href="#2-spring-app-구성">2) spring app 구성</a></li>
                    <li><a href="#1-nginx-설정">1) nginx 설정</a></li>
                  </ul>
                </li>
                <li><a href="#2-sample-app-test">2. sample app test</a>
                  <ul>
                    <li><a href="#3-scripts">3) scripts</a></li>
                    <li><a href="#2-docker-build">2) docker build</a></li>
                    <li><a href="#1-java-build">1) java build</a></li>
                  </ul>
                </li>
                <li><a href="#1-docker-환경-구성-ubuntu22">1. docker 환경 구성 (ubuntu22)</a>
                  <ul>
                    <li><a href="#1-nexus-구성">1) &rsquo;nexus&rsquo; 구성</a></li>
                    <li><a href="#2-docker-이미지-push">2) docker 이미지 push</a></li>
                    <li><a href="#3-java-app-컨테이너-실행">3) java-app 컨테이너 실행</a></li>
                  </ul>
                </li>
                <li><a href="#docker-설치-ubuntu22">docker 설치 (ubuntu22)</a></li>
                <li><a href="#docker-host-설정">docker host 설정</a></li>
                <li><a href="#locale">locale</a></li>
                <li><a href="#ufw-방화벽">ufw: 방화벽</a></li>
                <li><a href="#network">network</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



</aside>

</main>

  <footer class="footer">
Designed by MK
</footer>
</body>
</html>
