<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.87.0" /><META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>ELK | dlog</title>


  
  <meta name="description" content="elasticsearch 설치
artifacts.elastic.co 에서 rpm 다운로드 후 설치
$ curl -L -O …">
<meta property="og:title" content="ELK" />
<meta property="og:description" content="elasticsearch 설치 artifacts.elastic.co 에서 rpm 다운로드 후 설치
$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.16.3-x86_64.rpm $ rpm -i elasticsearch-7.16.3-x86_64.rpm $ systemctl restart elasticsearch $ curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-7.16.3-linux-x86_64.tar.gz $ rpm -i elasticsearch-7.16.3-x86_64.rpm 경고: elasticsearch-7.16.3-x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID d88e42b4: NOKEY Creating elasticsearch group... OK Creating elasticsearch user... OK ### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd sudo systemctl daemon-reload sudo systemctl enable elasticsearch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/system/elk/" /><meta property="article:section" content="system" />



<meta itemprop="name" content="ELK">
<meta itemprop="description" content="elasticsearch 설치 artifacts.elastic.co 에서 rpm 다운로드 후 설치
$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.16.3-x86_64.rpm $ rpm -i elasticsearch-7.16.3-x86_64.rpm $ systemctl restart elasticsearch $ curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-7.16.3-linux-x86_64.tar.gz $ rpm -i elasticsearch-7.16.3-x86_64.rpm 경고: elasticsearch-7.16.3-x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID d88e42b4: NOKEY Creating elasticsearch group... OK Creating elasticsearch user... OK ### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd sudo systemctl daemon-reload sudo systemctl enable elasticsearch.">

<meta itemprop="wordCount" content="2483">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ELK"/>
<meta name="twitter:description" content="elasticsearch 설치 artifacts.elastic.co 에서 rpm 다운로드 후 설치
$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.16.3-x86_64.rpm $ rpm -i elasticsearch-7.16.3-x86_64.rpm $ systemctl restart elasticsearch $ curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-7.16.3-linux-x86_64.tar.gz $ rpm -i elasticsearch-7.16.3-x86_64.rpm 경고: elasticsearch-7.16.3-x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID d88e42b4: NOKEY Creating elasticsearch group... OK Creating elasticsearch user... OK ### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd sudo systemctl daemon-reload sudo systemctl enable elasticsearch."/>




<link rel="preload" href="/scss/main.min.1f861d065398c88219fc317598d260b310e1d29b4fded8c05305f546ecc0046e.css" as="style">
<link href="/scss/main.min.1f861d065398c88219fc317598d260b310e1d29b4fded8c05305f546ecc0046e.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="/css/prism.css"/>









  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">dlog</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/system/" ><i class='fas fa-book'></i><span class="active">system</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/localenv/" ><i class='fas fa-book'></i><span>localenv</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/develop/" ><i class='fas fa-book'></i><span>develop</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.0de5675672003d5f331f9b806672b485.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.0de5675672003d5f331f9b806672b485.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>


    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-system-li">
  
  <a href="/system/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-system"><span class="">system</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemcentos8-li">
  
  <a href="/system/centos8/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemcentos8"><span class="">centos8</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-systemelk-li">
  
  <a href="/system/elk/" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id="m-systemelk"><span class="td-sidebar-nav-active-item">ELK</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemhttpd-li">
  
  <a href="/system/httpd/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemhttpd"><span class="">httpd</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemjenkins-li">
  
  <a href="/system/jenkins/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemjenkins"><span class="">jenkins</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemlinux-li">
  
  <a href="/system/linux/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemlinux"><span class="">linux</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemopenssh-li">
  
  <a href="/system/openssh/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemopenssh"><span class="">openssh</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemoracle12c-li">
  
  <a href="/system/oracle12c/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemoracle12c"><span class="">oracle12c</span></a>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
  
  
  
  
  
  
  <div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
  
  
  </div>


            


<div class="td-toc"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li><a href="#elasticsearch-설치">elasticsearch 설치</a></li>
                <li><a href="#elasticsearch-설정">elasticsearch 설정</a></li>
                <li><a href="#kibana-설치-binary">kibana 설치 (binary)</a></li>
                <li><a href="#kibana-설치-yum">kibana 설치 (yum)</a></li>
                <li><a href="#kibana-설정-binary">kibana 설정 (binary)</a></li>
                <li><a href="#kibana-설정-yum">kibana 설정 (yum)</a></li>
                <li><a href="#logstash-설치">logstash 설치</a></li>
                <li><a href="#filebeat-설치">filebeat 설치</a></li>
                <li><a href="#filebeat-설정">filebeat 설정</a></li>
                <li><a href="#filebeat-apache-module">filebeat) apache module</a></li>
                <li><a href="#logstash-설정">logstash 설정</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>



            

	
		



  
  

	
		



  
  

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		







<li class="breadcrumb-item" >
	<a href="/system/">system</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/system/elk/">ELK</a>
</li>

	</ol>
</nav	>

            
<div class="td-content">
	<h1>ELK</h1>
	
	<header class="article-meta">
		
		
			
				


			
				


			
		
		
	</header>    
	<h5 id="elasticsearch-설치">elasticsearch 설치</h5>
<p><code>artifacts.elastic.co</code> 에서 rpm 다운로드 후 설치</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.16.3-x86_64.rpm
$ rpm -i elasticsearch-7.16.3-x86_64.rpm
$ systemctl restart elasticsearch
$ curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-7.16.3-linux-x86_64.tar.gz
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ rpm -i elasticsearch-7.16.3-x86_64.rpm
경고: elasticsearch-7.16.3-x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID d88e42b4: NOKEY
Creating elasticsearch group... OK
Creating elasticsearch user... OK
<span style="color:#75715e">### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd</span>
 sudo systemctl daemon-reload
 sudo systemctl enable elasticsearch.service
<span style="color:#75715e">### You can start elasticsearch service by executing</span>
 sudo systemctl start elasticsearch.service
warning: usage of JAVA_HOME is deprecated, use ES_JAVA_HOME
Created elasticsearch keystore in /etc/elasticsearch/elasticsearch.keystore
<span style="color:#f92672">[</span>/usr/lib/tmpfiles.d/elasticsearch.conf:1<span style="color:#f92672">]</span> Line references path below legacy directory /var/run/, updating /var/run/elasticsearch → /run/elasticsearch; please update the tmpfiles.d/ drop-in file accordingly.
$ curl http://127.0.0.1:9200
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;centos8&#34;</span>,
  <span style="color:#e6db74">&#34;cluster_name&#34;</span> : <span style="color:#e6db74">&#34;elasticsearch&#34;</span>,
  <span style="color:#e6db74">&#34;cluster_uuid&#34;</span> : <span style="color:#e6db74">&#34;_e3hsZBwTtS2aAyJvCfqbA&#34;</span>,
  <span style="color:#e6db74">&#34;version&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;number&#34;</span> : <span style="color:#e6db74">&#34;7.16.3&#34;</span>,
    <span style="color:#e6db74">&#34;build_flavor&#34;</span> : <span style="color:#e6db74">&#34;default&#34;</span>,
    <span style="color:#e6db74">&#34;build_type&#34;</span> : <span style="color:#e6db74">&#34;rpm&#34;</span>,
    <span style="color:#e6db74">&#34;build_hash&#34;</span> : <span style="color:#e6db74">&#34;4e6e4eab2297e949ec994e688dad46290d018022&#34;</span>,
    <span style="color:#e6db74">&#34;build_date&#34;</span> : <span style="color:#e6db74">&#34;2022-01-06T23:43:02.825887787Z&#34;</span>,
    <span style="color:#e6db74">&#34;build_snapshot&#34;</span> : false,
    <span style="color:#e6db74">&#34;lucene_version&#34;</span> : <span style="color:#e6db74">&#34;8.10.1&#34;</span>,
    <span style="color:#e6db74">&#34;minimum_wire_compatibility_version&#34;</span> : <span style="color:#e6db74">&#34;6.8.0&#34;</span>,
    <span style="color:#e6db74">&#34;minimum_index_compatibility_version&#34;</span> : <span style="color:#e6db74">&#34;6.0.0-beta1&#34;</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;tagline&#34;</span> : <span style="color:#e6db74">&#34;You Know, for Search&#34;</span>
<span style="color:#f92672">}</span>
$
</code></pre></div><!-- raw HTML omitted -->
<h5 id="elasticsearch-설정">elasticsearch 설정</h5>
<p>설정 파일 <code>/etc/elasticsearch/elasticsearch.yml</code>에서 데이터/로그 디렉토리 변경</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">##</span>
$ mkdir -p /data/PROD/es <span style="color:#f92672">&amp;&amp;</span> chown elasticsearch:elasticsearch /data/PROD/es
$ mkdir -p /data/PROD/es <span style="color:#f92672">&amp;&amp;</span> chown elasticsearch:elasticsearch /outlog/PROD/es

<span style="color:#75715e">## </span>
 <span style="color:#ae81ff">33</span> <span style="color:#75715e">#path.data: /var/lib/elasticsearch</span>
 <span style="color:#ae81ff">34</span> path.data: /data/PROD/es
 <span style="color:#ae81ff">38</span> <span style="color:#75715e">#path.logs: /var/log/elasticsearch</span>
 <span style="color:#ae81ff">39</span> path.logs: /outlog/PROD/es
 <span style="color:#ae81ff">58</span> <span style="color:#75715e">#network.host: 192.168.0.1</span>
 <span style="color:#ae81ff">59</span> network.host: 0.0.0.0
 <span style="color:#ae81ff">73</span> <span style="color:#75715e">#discovery.seed_hosts: [&#34;host1&#34;, &#34;host2&#34;]</span>
 <span style="color:#ae81ff">74</span> discovery.seed_hosts: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;0.0.0.0&#34;</span><span style="color:#f92672">]</span>
</code></pre></div><!-- raw HTML omitted -->
<h5 id="kibana-설치-binary">kibana 설치 (binary)</h5>
<p><code>artifacts.elastic.co</code>에서 tar.gz 다운로드 후 아카이브 해제</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-7.16.3-linux-x86_64.tar.gz
$ tar zxvf kibana-7.16.3-linux-x86_64.tar.gz
$ mkdir -p /prod/kibana
$ mv kibana-7.16.3-linux-x86_64 /prod/kibana
$ cd /prod/kibana <span style="color:#f92672">&amp;&amp;</span> ln -s kibana-7.16.3-linux-x86_64 kibana
$ chown -R tomcat:ap /prod/kibana
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ tree -L <span style="color:#ae81ff">2</span>
.
├── kibana -&gt; kibana-7.16.3-linux-x86_64/
└── kibana-7.16.3-linux-x86_64
    ├── LICENSE.txt
    ├── NOTICE.txt
    ├── README.txt
    ├── bin
    ├── config
    ├── data
    ├── node
    ├── node_modules
    ├── package.json
    ├── plugins
    ├── src
    └── x-pack

<span style="color:#ae81ff">10</span> directories, <span style="color:#ae81ff">4</span> files
$
</code></pre></div><!-- raw HTML omitted -->
<h5 id="kibana-설치-yum">kibana 설치 (yum)</h5>
<p>PGP 를 추가합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch
</code></pre></div><p><code>vi /etc/yum.repos.d/kibana.repo</code> 아래 내용을 추가합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>kibana-7.x<span style="color:#f92672">]</span>
name<span style="color:#f92672">=</span>Kibana repository <span style="color:#66d9ef">for</span> 7.x packages
baseurl<span style="color:#f92672">=</span>https://artifacts.elastic.co/packages/7.x/yum
gpgcheck<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
gpgkey<span style="color:#f92672">=</span>https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
autorefresh<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
type<span style="color:#f92672">=</span>rpm-md
</code></pre></div><p>yum 으로 kibana 를 설치합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ yum install kibana
</code></pre></div><p>systemd</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ systemctl enable kibana
$ systemctl start kibana
</code></pre></div><!-- raw HTML omitted -->
<h5 id="kibana-설정-binary">kibana 설정 (binary)</h5>
<p>설정 파일 <code>/prod/kibana/kibana/config/kibana.yml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 기본 설정 파일로 실행 시 `server.publicBaseUrl` 에 대한 경고가 표시 됩니다.</span>
<span style="color:#75715e"># &#34;server.publicBaseUrl&#34; 는 &#34;server.basePath&#34; 의 경로를 반드시 포함해야 합니다.</span>
 <span style="color:#ae81ff">24</span> <span style="color:#75715e">#server.publicBaseUrl: &#34;&#34;</span>
 <span style="color:#ae81ff">25</span> server.publicBaseUrl: <span style="color:#e6db74">&#34;http://localhost:5601&#34;</span>
<span style="color:#75715e"># logging off</span>
 <span style="color:#ae81ff">103</span> <span style="color:#75715e">#logging.silent: false</span>
 <span style="color:#ae81ff">104</span> logging.silent: true
</code></pre></div><p><!-- raw HTML omitted --><a href="http://www.elastic.co">www.elastic.co</a> kibana 설정 가이드<!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<h5 id="kibana-설정-yum">kibana 설정 (yum)</h5>
<p>설정 파일 <code>/etc/kibana/kibana.yml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">server.port: <span style="color:#ae81ff">5601</span>
server.publicBaseUrl: <span style="color:#e6db74">&#34;http://localhost:5601&#34;</span>
logging.silent: true
</code></pre></div><p><!-- raw HTML omitted -->rpm-layout<!-- raw HTML omitted --></p>
<ul>
<li>설정: /etc/kibana</li>
<li>로그: /var/log/kibana</li>
<li>데이터: /var/lib/kibana</li>
</ul>
<!-- raw HTML omitted -->
<p>httpd 가상호스트 설정</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">&lt;VirtualHost *:80&gt;
  ServerName kibana

  ErrorLog <span style="color:#e6db74">&#34;|/usr/sbin/rotatelogs /outlog/WEB/httpd/kibana-error.log.%Y-%m-%d 86400 +540%&#34;</span>
  CustomLog <span style="color:#e6db74">&#34;|/usr/sbin/rotatelogs /outlog/WEB/httpd/kibana-access.log.%Y-%m-%d 86400 +540%&#34;</span> combined

  AllowEncodedSlashes On
  Header set Access-Control-Allow-Origin <span style="color:#e6db74">&#34;*&#34;</span>

  ProxyRequests Off
  ProxyPreserveHost On

  &lt;Proxy *&gt;
    Require all granted
  &lt;/Proxy&gt;

  ProxyPass / http://localhost:5601/        <span style="color:#75715e"># &#34;kibana.yml&#34; 파일 &#34;server.host&#34; 에 설정된 호스트로 할 것</span>
  ProxyPassReverse / http://localhost:5601/
&lt;/VirtualHost&gt;
</code></pre></div><!-- raw HTML omitted -->
<p>kibana는 elasticsearch 와 connect 가 되지 않은 상태일 경우 <code>Kibana server is not ready yet</code> 메시지가 표시됩니다.</p>
<pre><code>#/etc/kibana/kibana.yml
#elasticsearch.hosts: [&quot;http://localhost:9200&quot;]
elasticsearch.hosts: [&quot;http://localhost:8200&quot;]
</code></pre><!-- raw HTML omitted -->
<h5 id="logstash-설치">logstash 설치</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ yum install logstash
</code></pre></div><p>systemd</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ systemctl enable logstash
$ systemctl start logstash
</code></pre></div><!-- raw HTML omitted -->
<h5 id="filebeat-설치">filebeat 설치</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ yum list filebeat
</code></pre></div><h5 id="filebeat-설정">filebeat 설정</h5>
<p>filebeat 와 elasticsearch 의 관계를 설명하는 다이어그램입니다.</p>
<p>filebeat의 주요 기능은 는 로그파일을 읽어들이고(<code>input</code>) elasticsearch 혹은 logstash 로 출력(<code>output</code>)하는 것입니다.</p>
<!-- raw HTML omitted -->
<p><!-- raw HTML omitted -->새 창 보기<!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>filebeat 설정 파일<code>/etc/filebeat/filebeat.yml</code>에 기본 설정된 상태를 보면 <code>output.elasticsearch</code> 가 활성화 되어있고, <code>output.logstash</code>는  비활성화로 되어있습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ae81ff">132</span> output.elasticsearch:
<span style="color:#ae81ff">133</span>   <span style="color:#75715e"># Array of hosts to connect to.</span>
<span style="color:#ae81ff">134</span>   hosts: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;localhost:9200&#34;</span><span style="color:#f92672">]</span>
...
<span style="color:#ae81ff">145</span> <span style="color:#75715e">#output.logstash:</span>
<span style="color:#ae81ff">146</span>   <span style="color:#75715e"># The Logstash hosts</span>
<span style="color:#ae81ff">147</span>   <span style="color:#75715e">#hosts: [&#34;localhost:5044&#34;]</span>
</code></pre></div><!-- raw HTML omitted -->
<p>filebeat 를 yum 으로 설치했을 경우 systemd 에 추가할 수 있습니다.</p>
<p>기본적인 운용 개념은 다음과 같습니다.</p>
<ul>
<li>filebeat 서비스 실행</li>
<li>filebeat 설정 변경 및 모듈 추가</li>
<li>filebeat 서비스 재시작</li>
<li>kibana 에서 filebeat 가 elasticsearch 로 출력(<code>output</code>)한 내용 확인</li>
<li>filebeat 모듈 설정 (예: 활성화 상태 변경)</li>
<li>filebeat 서비스 재시작으로 모듈 설정된 내용 반영</li>
</ul>
<p>주요 내용은 설정을 변경하면 filebeat 서비스를 재시작해야 반영된다는 사항이 있습니다.</p>
<!-- raw HTML omitted -->
<h5 id="filebeat-apache-module">filebeat) apache module</h5>
<p>filebeat 가 읽어들일 로그파일이 잘 알려진 프로그램의 로그일 경우 modules 에 포함 되어있습니다.</p>
<p>그 중 apache 모듈에 access_log 를 읽어들이도록 모듈을 설정하고 활성화하는 예시입니다.</p>
<p>(활성화된 모듈 목록을 확인하고 apache 모듈을 enable 해봅니다.)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ filebeat modules list
Enabled:

Disabled:
activemq
apache
auditd
...
$ 
$ filebeat modules enable apache
Enabled apache
$ 
$ filebeat modules list
Enabled:
apache

Disabled:
activemq
auditd
$ 
</code></pre></div><p>filebeat 의 module 설정은 아래 경로에 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ls /etc/filebeat/modules.d/
activemq.yml.disabled     cylance.yml.disabled           iptables.yml.disabled         o365.yml.disabled        sophos.yml.disabled
apache.yml                elasticsearch.yml.disabled     juniper.yml.disabled          okta.yml.disabled        squid.yml.disabled
auditd.yml.disabled       envoyproxy.yml.disabled        kafka.yml.disabled            oracle.yml.disabled      suricata.yml.disabled
aws.yml.disabled          f5.yml.disabled                kibana.yml.disabled           osquery.yml.disabled     system.yml.disabled
awsfargate.yml.disabled   fortinet.yml.disabled          logstash.yml.disabled         panw.yml.disabled        threatintel.yml.disabled
azure.yml.disabled        gcp.yml.disabled               microsoft.yml.disabled        pensando.yml.disabled    tomcat.yml.disabled
barracuda.yml.disabled    google_workspace.yml.disabled  misp.yml.disabled             postgresql.yml.disabled  traefik.yml.disabled
bluecoat.yml.disabled     googlecloud.yml.disabled       mongodb.yml.disabled          proofpoint.yml.disabled  zeek.yml.disabled
cef.yml.disabled          gsuite.yml.disabled            mssql.yml.disabled            rabbitmq.yml.disabled    zookeeper.yml.disabled
checkpoint.yml.disabled   haproxy.yml.disabled           mysql.yml.disabled            radware.yml.disabled     zoom.yml.disabled
cisco.yml.disabled        ibmmq.yml.disabled             mysqlenterprise.yml.disabled  redis.yml.disabled       zscaler.yml.disabled
coredns.yml.disabled      icinga.yml.disabled            nats.yml.disabled             santa.yml.disabled
crowdstrike.yml.disabled  iis.yml.disabled               netflow.yml.disabled          snort.yml.disabled
cyberark.yml.disabled     imperva.yml.disabled           netscout.yml.disabled         snyk.yml.disabled
cyberarkpas.yml.disabled  infoblox.yml.disabled          nginx.yml.disabled            sonicwall.yml.disabled
$ 
$ ls -al /etc/filebeat/modules.d/apache.yml
-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">476</span> 2022-01-07 09:36 /etc/filebeat/modules.d/apache.yml
</code></pre></div><p><code>apache.yml</code>에 access_log, error_log 를 수집할 수 있도록 설정합니다.</p>
<p>설정 전 확인할 사항</p>
<ul>
<li>access_log 경로: (예) <code>/outlog/WEB/httpd/nexus_ssl-access.log.2022-01-26</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">- module: apache
  access:
    enabled: true
    input:
      fields:
        server_name: develop-httpd
        log_type: nexus_access
    var.paths: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/outlog/WEB/httpd/nexus_ssl-access.log.*&#34;</span><span style="color:#f92672">]</span>

  error:
    enabled: true
    <span style="color:#75715e">#var.paths: []</span>
</code></pre></div><p><code>filebeat modules enable apache</code> 명령으로 모듈을 활성화 상태로 설정합니다.</p>
<p><code>systemctl restart filebeat</code> 명령으로 서비스를 재시작합니다.</p>
<p>아래와 같이 kibana 에서 access_log 를 확인합니다.</p>
<!-- raw HTML omitted -->
<p><!-- raw HTML omitted -->새 창 보기<!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<h5 id="logstash-설정">logstash 설정</h5>
<p>실행파일<code>/usr/share/logstash/bin/logstash</code>이 PATH 에 추가하는 것을 권합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">export LOGSTASH_HOME<span style="color:#f92672">=</span>/usr/share/logstash
export PATH<span style="color:#f92672">=</span>$PATH:/usr/local/go/bin:$LOGSTASH_HOME/bin
</code></pre></div><p>logstash 가 동작하는 방식을 이해하기 위한 단계별 예시입니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># logstash daemon 을 실행합니다.</span>
<span style="color:#75715e"># -e 파라미터에는 매우 단순한 표준 입출력을 정의했습니다.</span>
<span style="color:#75715e"># daemon </span>
$ logstash -e <span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">input {
</span><span style="color:#e6db74">  stdin {}
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74">output {
</span><span style="color:#e6db74">  stdout {}
</span><span style="color:#e6db74">}&#39;</span>
</code></pre></div><!-- raw HTML omitted -->
<p>별도의 터미널을 열고 logstash 9900 에 &ldquo;hello logstash&rdquo; 문자열을 nc(NetCat)명령어로 전송해봅니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ echo <span style="color:#e6db74">&#34;hello logstash&#34;</span> | nc localhost <span style="color:#ae81ff">9900</span>
</code></pre></div><p>logstash 콘솔에서는 &ldquo;hello logstash&rdquo; 문자열을 stdout 으로 출력한 문자열을 볼 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;@version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1&#34;</span>,
          <span style="color:#e6db74">&#34;host&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;localhost&#34;</span>,
          <span style="color:#e6db74">&#34;port&#34;</span> <span style="color:#f92672">=</span>&gt; 64924,
       <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;hello logstash&#34;</span>,
    <span style="color:#e6db74">&#34;@timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; 2022-01-26T16:20:17.308Z
<span style="color:#f92672">}</span>
</code></pre></div><p>exam_tpc.ls 라는 텍스트 파일을 생성하고 logstash daemon 을 실행합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ vi exam_tcp.ls
input <span style="color:#f92672">{</span>
  tcp <span style="color:#f92672">{</span>
    port <span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">9900</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
output <span style="color:#f92672">{</span>
  stdout <span style="color:#f92672">{}</span>
<span style="color:#f92672">}</span>
$ logstash -f exam_tcp.ls
</code></pre></div><p>nc 명령으로 &ldquo;hello&rdquo; 문자열을 전송해봅니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ echo <span style="color:#e6db74">&#34;hello&#34;</span> | nc localhost <span style="color:#ae81ff">9900</span>
<span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;@version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1&#34;</span>,
          <span style="color:#e6db74">&#34;host&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;localhost&#34;</span>,
          <span style="color:#e6db74">&#34;port&#34;</span> <span style="color:#f92672">=</span>&gt; 64924,
       <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;hello&#34;</span>,
    <span style="color:#e6db74">&#34;@timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; 2022-01-26T16:30:27.908Z
<span style="color:#f92672">}</span>
</code></pre></div><p><code>logstash -f filename</code> 형태로 실행했을 경우 <code>filename</code>에 변경이 있을 경우 자동으로 reload 하는 설정을 합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ vi /etc/logstash/logstash.yml
<span style="color:#75715e"># config.reload.automatic: false</span>
config.reload.automatic: true
<span style="color:#75715e"># config.reload.interval: 3s</span>
config.reload.interval: 1s
</code></pre></div><p>설정이 안될 때에는 실행 시 옵션으로 할 수 있습니다.</p>
<p><code>logstash -f filename --config.reload.automatic</code></p>
<p>apache access 로그파일을 하나 준비합니다.</p>
<p>(참고로 apache 로그파일의 레이아웃은 기본이어야 합니다.)</p>
<p>로그파일의 1번째 행을 읽어들이고 9900 으로 전송하고 logstash 에서 처리한 로그를 확인합니다.</p>
<p>&ldquo;message&rdquo; 필드에 보낸 문자열을 출력하고 있는 점을 확인하면 됩니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cp /outlog/WEB/httpd/dwww-access.log.2022-01-09 weblog.txt
$ head -n <span style="color:#ae81ff">1</span> weblog.txt  | nc localhost <span style="color:#ae81ff">9900</span>
<span style="color:#f92672">{</span>
          <span style="color:#e6db74">&#34;port&#34;</span> <span style="color:#f92672">=</span>&gt; 65366,
      <span style="color:#e6db74">&#34;@version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1&#34;</span>,
          <span style="color:#e6db74">&#34;host&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;localhost&#34;</span>,
       <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
    <span style="color:#e6db74">&#34;@timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; 2022-01-26T16:48:45.155Z
<span style="color:#f92672">}</span>
</code></pre></div><p>이번에는 exam_filter.ls 파일을 생성하고, filter 에 <code>grok</code>을 이용하여 &ldquo;message&rdquo; 필드를 parsing 해보겠습니다.</p>
<p><code>grok</code> 에 대한 설명은 아래 링크로 대체합니다.</p>
<p><!-- raw HTML omitted -->새 창 보기<!-- raw HTML omitted --></p>
<p><code>grok-filter</code>에 의해 message 가 parsing 된 결과를 확인할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ logstash -f exam_filter.ls

$ vi exam_filter.ls
input <span style="color:#f92672">{</span>
  tcp <span style="color:#f92672">{</span>
    port <span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">9900</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

filter <span style="color:#f92672">{</span>
  grok <span style="color:#f92672">{</span>
    match <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;%{COMBINEDAPACHELOG}&#34;</span> <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
output <span style="color:#f92672">{</span>
  stdout <span style="color:#f92672">{}</span>
<span style="color:#f92672">}</span>

$ head -n <span style="color:#ae81ff">1</span> weblog.txt | nc localhost <span style="color:#ae81ff">9900</span>
<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;httpversion&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1.1&#34;</span>,
           <span style="color:#e6db74">&#34;host&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;localhost&#34;</span>,
        <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
       <span style="color:#e6db74">&#34;referrer&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;\&#34;http://dwww/status.html\&#34;&#34;</span>,
          <span style="color:#e6db74">&#34;agent&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;\&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
          <span style="color:#e6db74">&#34;ident&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;-&#34;</span>,
       <span style="color:#e6db74">&#34;@version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1&#34;</span>,
       <span style="color:#e6db74">&#34;clientip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90&#34;</span>,
          <span style="color:#e6db74">&#34;bytes&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;299&#34;</span>,
      <span style="color:#e6db74">&#34;timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;09/Jan/2022:17:52:49 +0900&#34;</span>,
           <span style="color:#e6db74">&#34;auth&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;-&#34;</span>,
     <span style="color:#e6db74">&#34;@timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; 2022-01-26T16:59:54.543Z,
       <span style="color:#e6db74">&#34;response&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;503&#34;</span>,
           <span style="color:#e6db74">&#34;port&#34;</span> <span style="color:#f92672">=</span>&gt; 9122,
           <span style="color:#e6db74">&#34;verb&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;GET&#34;</span>,
        <span style="color:#e6db74">&#34;request&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/resources/jquery.min.js&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>grok-filter</code>에서 parsing 되어 생성된 필드인 <code>&quot;clientip&quot;</code>를 <code>geoip-filter</code>가 처리할 수 있도록 설정하고 테스트 해봅니다.</p>
<p><code>geoip-filter</code>는 <code>grok-filter</code> 다음에 정의해야 한다는 것을 이해해야 합니다.</p>
<p>처리 결과에 geoip 라는 필드에 하위 세부 정보가 출력되는 것을 확인할 수 있습니다.</p>
<p>geoip 에 대한 설명은 아래 링크로 대체 합니다.</p>
<p><!-- raw HTML omitted -->새 창 보기<!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># grok 에서 parsing 된 정보 중 clientip 필드를 geoip 필터에 전달한다는 의미</span>
$ vi exam_filter.ls
input <span style="color:#f92672">{</span>
  tcp <span style="color:#f92672">{</span>
    port <span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">9900</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
filter <span style="color:#f92672">{</span>
  grok <span style="color:#f92672">{</span>
    match <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;%{COMBINEDAPACHELOG}&#34;</span> <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  geoip <span style="color:#f92672">{</span>
    source <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;clientip&#34;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
output <span style="color:#f92672">{</span>
  stdout <span style="color:#f92672">{}</span>
<span style="color:#f92672">}</span>

$ head -n <span style="color:#ae81ff">1</span> weblog.txt | nc localhost <span style="color:#ae81ff">9900</span>
<span style="color:#f92672">{</span>
           <span style="color:#e6db74">&#34;auth&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;-&#34;</span>,
     <span style="color:#e6db74">&#34;@timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; 2022-01-26T17:08:31.046Z,
       <span style="color:#e6db74">&#34;response&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;503&#34;</span>,
        <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
           <span style="color:#e6db74">&#34;port&#34;</span> <span style="color:#f92672">=</span>&gt; 9306,
          <span style="color:#e6db74">&#34;ident&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;-&#34;</span>,
          <span style="color:#e6db74">&#34;agent&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;\&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
           <span style="color:#e6db74">&#34;host&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;localhost&#34;</span>,
        <span style="color:#e6db74">&#34;request&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/resources/jquery.min.js&#34;</span>,
       <span style="color:#e6db74">&#34;@version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1&#34;</span>,
           <span style="color:#e6db74">&#34;verb&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;GET&#34;</span>,
          <span style="color:#e6db74">&#34;geoip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
             <span style="color:#e6db74">&#34;longitude&#34;</span> <span style="color:#f92672">=</span>&gt; 126.9754,
         <span style="color:#e6db74">&#34;country_code3&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;KR&#34;</span>,
           <span style="color:#e6db74">&#34;region_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;11&#34;</span>,
             <span style="color:#e6db74">&#34;city_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Seoul&#34;</span>,
          <span style="color:#e6db74">&#34;country_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;South Korea&#34;</span>,
           <span style="color:#e6db74">&#34;region_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Seoul&#34;</span>,
              <span style="color:#e6db74">&#34;location&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;lat&#34;</span> <span style="color:#f92672">=</span>&gt; 37.5794,
            <span style="color:#e6db74">&#34;lon&#34;</span> <span style="color:#f92672">=</span>&gt; 126.9754
        <span style="color:#f92672">}</span>,
              <span style="color:#e6db74">&#34;latitude&#34;</span> <span style="color:#f92672">=</span>&gt; 37.5794,
        <span style="color:#e6db74">&#34;continent_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;AS&#34;</span>,
         <span style="color:#e6db74">&#34;country_code2&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;KR&#34;</span>,
           <span style="color:#e6db74">&#34;postal_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;04524&#34;</span>,
                    <span style="color:#e6db74">&#34;ip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90&#34;</span>,
              <span style="color:#e6db74">&#34;timezone&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Asia/Seoul&#34;</span>
    <span style="color:#f92672">}</span>,
      <span style="color:#e6db74">&#34;timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;09/Jan/2022:17:52:49 +0900&#34;</span>,
          <span style="color:#e6db74">&#34;bytes&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;299&#34;</span>,
       <span style="color:#e6db74">&#34;referrer&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;\&#34;http://dwww/status.html\&#34;&#34;</span>,
    <span style="color:#e6db74">&#34;httpversion&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1.1&#34;</span>,
       <span style="color:#e6db74">&#34;clientip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>logstash 의 output 으로 나오는 항목들은 모두 문자열입니다.</p>
<p>결과 필드를 정수(integer)형으로 변환하는 기능을 추가합니다.</p>
<p>filter 에 <code>mutate</code> 를 보면 됩니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ vi exam_filter.ls
input <span style="color:#f92672">{</span>
  tcp <span style="color:#f92672">{</span>
    port <span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">9900</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
filter <span style="color:#f92672">{</span>
  grok <span style="color:#f92672">{</span>
    match <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;%{COMBINEDAPACHELOG}&#34;</span> <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  geoip <span style="color:#f92672">{</span>
    source <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;clientip&#34;</span>
  <span style="color:#f92672">}</span>
  mutate <span style="color:#f92672">{</span>
    convert <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;bytes&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;integer&#34;</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
output <span style="color:#f92672">{</span>
  stdout <span style="color:#f92672">{}</span>
<span style="color:#f92672">}</span>


$ head -n <span style="color:#ae81ff">1</span> weblog.txt | nc localhost <span style="color:#ae81ff">9900</span>
<span style="color:#f92672">{</span>
           <span style="color:#e6db74">&#34;auth&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;-&#34;</span>,
           <span style="color:#e6db74">&#34;host&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;localhost&#34;</span>,
       <span style="color:#e6db74">&#34;response&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;503&#34;</span>,
           <span style="color:#e6db74">&#34;verb&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;GET&#34;</span>,
        <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
           <span style="color:#e6db74">&#34;port&#34;</span> <span style="color:#f92672">=</span>&gt; 9540,
          <span style="color:#e6db74">&#34;bytes&#34;</span> <span style="color:#f92672">=</span>&gt; 299,
          <span style="color:#e6db74">&#34;geoip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;continent_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;AS&#34;</span>,
           <span style="color:#e6db74">&#34;region_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Seoul&#34;</span>,
           <span style="color:#e6db74">&#34;postal_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;04524&#34;</span>,
              <span style="color:#e6db74">&#34;timezone&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Asia/Seoul&#34;</span>,
         <span style="color:#e6db74">&#34;country_code3&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;KR&#34;</span>,
          <span style="color:#e6db74">&#34;country_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;South Korea&#34;</span>,
                    <span style="color:#e6db74">&#34;ip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90&#34;</span>,
           <span style="color:#e6db74">&#34;region_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;11&#34;</span>,
             <span style="color:#e6db74">&#34;city_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Seoul&#34;</span>,
              <span style="color:#e6db74">&#34;latitude&#34;</span> <span style="color:#f92672">=</span>&gt; 37.5794,
         <span style="color:#e6db74">&#34;country_code2&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;KR&#34;</span>,
             <span style="color:#e6db74">&#34;longitude&#34;</span> <span style="color:#f92672">=</span>&gt; 126.9754,
              <span style="color:#e6db74">&#34;location&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;lat&#34;</span> <span style="color:#f92672">=</span>&gt; 37.5794,
            <span style="color:#e6db74">&#34;lon&#34;</span> <span style="color:#f92672">=</span>&gt; 126.9754
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>,
          <span style="color:#e6db74">&#34;ident&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;-&#34;</span>,
     <span style="color:#e6db74">&#34;@timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; 2022-01-26T17:19:32.250Z,
       <span style="color:#e6db74">&#34;@version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1&#34;</span>,
      <span style="color:#e6db74">&#34;timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;09/Jan/2022:17:52:49 +0900&#34;</span>,
          <span style="color:#e6db74">&#34;agent&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;\&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
        <span style="color:#e6db74">&#34;request&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/resources/jquery.min.js&#34;</span>,
       <span style="color:#e6db74">&#34;clientip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90&#34;</span>,
       <span style="color:#e6db74">&#34;referrer&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;\&#34;http://dwww/status.html\&#34;&#34;</span>,
    <span style="color:#e6db74">&#34;httpversion&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1.1&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>useragent</code>라는 filter 가 있습니다.</p>
<p>apache log 에 기본 포함되어있는 &ldquo;agent&rdquo; 필드를 parsing 하여 세분화합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ vi exam_filter.ls
input <span style="color:#f92672">{</span>
  tcp <span style="color:#f92672">{</span>
    port <span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">9900</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
filter <span style="color:#f92672">{</span>
  grok <span style="color:#f92672">{</span>
    match <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;%{COMBINEDAPACHELOG}&#34;</span> <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  geoip <span style="color:#f92672">{</span>
    source <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;clientip&#34;</span>
  <span style="color:#f92672">}</span>
  mutate <span style="color:#f92672">{</span>
    convert <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;bytes&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;integer&#34;</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  useragent <span style="color:#f92672">{</span>
    source <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;agent&#34;</span>
    target <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;useragent&#34;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
output <span style="color:#f92672">{</span>
  stdout <span style="color:#f92672">{}</span>
<span style="color:#f92672">}</span>

$ head -n <span style="color:#ae81ff">1</span> weblog.txt | nc localhost <span style="color:#ae81ff">9900</span>
<span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;request&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/resources/jquery.min.js&#34;</span>,
          <span style="color:#e6db74">&#34;bytes&#34;</span> <span style="color:#f92672">=</span>&gt; 299,
        <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
          <span style="color:#e6db74">&#34;ident&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;-&#34;</span>,
    <span style="color:#e6db74">&#34;httpversion&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1.1&#34;</span>,
          <span style="color:#e6db74">&#34;geoip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
           <span style="color:#e6db74">&#34;postal_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;04524&#34;</span>,
             <span style="color:#e6db74">&#34;city_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Seoul&#34;</span>,
        <span style="color:#e6db74">&#34;continent_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;AS&#34;</span>,
          <span style="color:#e6db74">&#34;country_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;South Korea&#34;</span>,
           <span style="color:#e6db74">&#34;region_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;11&#34;</span>,
              <span style="color:#e6db74">&#34;timezone&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Asia/Seoul&#34;</span>,
         <span style="color:#e6db74">&#34;country_code2&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;KR&#34;</span>,
         <span style="color:#e6db74">&#34;country_code3&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;KR&#34;</span>,
              <span style="color:#e6db74">&#34;location&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;lat&#34;</span> <span style="color:#f92672">=</span>&gt; 37.5794,
            <span style="color:#e6db74">&#34;lon&#34;</span> <span style="color:#f92672">=</span>&gt; 126.9754
        <span style="color:#f92672">}</span>,
           <span style="color:#e6db74">&#34;region_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Seoul&#34;</span>,
             <span style="color:#e6db74">&#34;longitude&#34;</span> <span style="color:#f92672">=</span>&gt; 126.9754,
              <span style="color:#e6db74">&#34;latitude&#34;</span> <span style="color:#f92672">=</span>&gt; 37.5794,
                    <span style="color:#e6db74">&#34;ip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90&#34;</span>
    <span style="color:#f92672">}</span>,
           <span style="color:#e6db74">&#34;auth&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;-&#34;</span>,
       <span style="color:#e6db74">&#34;referrer&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;\&#34;http://dwww/status.html\&#34;&#34;</span>,
       <span style="color:#e6db74">&#34;response&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;503&#34;</span>,
      <span style="color:#e6db74">&#34;useragent&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
          <span style="color:#e6db74">&#34;os_major&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;10&#34;</span>,
        <span style="color:#e6db74">&#34;os_version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;10&#34;</span>,
           <span style="color:#e6db74">&#34;os_full&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Windows 10&#34;</span>,
             <span style="color:#e6db74">&#34;minor&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;0&#34;</span>,
                <span style="color:#e6db74">&#34;os&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Windows&#34;</span>,
              <span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Chrome&#34;</span>,
             <span style="color:#e6db74">&#34;patch&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;4692&#34;</span>,
             <span style="color:#e6db74">&#34;major&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;97&#34;</span>,
           <span style="color:#e6db74">&#34;version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;97.0.4692.71&#34;</span>,
           <span style="color:#e6db74">&#34;os_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Windows&#34;</span>,
            <span style="color:#e6db74">&#34;device&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Other&#34;</span>
    <span style="color:#f92672">}</span>,
           <span style="color:#e6db74">&#34;verb&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;GET&#34;</span>,
     <span style="color:#e6db74">&#34;@timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; 2022-01-26T17:23:55.151Z,
      <span style="color:#e6db74">&#34;timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;09/Jan/2022:17:52:49 +0900&#34;</span>,
           <span style="color:#e6db74">&#34;host&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;localhost&#34;</span>,
          <span style="color:#e6db74">&#34;agent&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;\&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
       <span style="color:#e6db74">&#34;@version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1&#34;</span>,
           <span style="color:#e6db74">&#34;port&#34;</span> <span style="color:#f92672">=</span>&gt; 9638,
       <span style="color:#e6db74">&#34;clientip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>date</code> filter 입니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ vi exam_filter.ls
input <span style="color:#f92672">{</span>
  tcp <span style="color:#f92672">{</span>
    port <span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">9900</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
filter <span style="color:#f92672">{</span>
  grok <span style="color:#f92672">{</span>
    match <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;%{COMBINEDAPACHELOG}&#34;</span> <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  geoip <span style="color:#f92672">{</span>
    source <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;clientip&#34;</span>
  <span style="color:#f92672">}</span>
  mutate <span style="color:#f92672">{</span>
    convert <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;bytes&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;integer&#34;</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  useragent <span style="color:#f92672">{</span>
    source <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;agent&#34;</span>
    target <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;useragent&#34;</span>
  <span style="color:#f92672">}</span>
  date <span style="color:#f92672">{</span>
    match <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;timestamp&#34;</span>, <span style="color:#e6db74">&#34;dd/MMM/yyyy:HH:mm:ss Z&#34;</span><span style="color:#f92672">]</span>
    target <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;logdate&#34;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
output <span style="color:#f92672">{</span>
  stdout <span style="color:#f92672">{}</span>
<span style="color:#f92672">}</span>

$ head -n <span style="color:#ae81ff">1</span> weblog.txt | nc localhost <span style="color:#ae81ff">9900</span>
<span style="color:#f92672">{</span>
           <span style="color:#e6db74">&#34;port&#34;</span> <span style="color:#f92672">=</span>&gt; 9818,
        <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
       <span style="color:#e6db74">&#34;clientip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90&#34;</span>,
          <span style="color:#e6db74">&#34;ident&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;-&#34;</span>,
       <span style="color:#e6db74">&#34;referrer&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;\&#34;http://dwww/status.html\&#34;&#34;</span>,
          <span style="color:#e6db74">&#34;agent&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;\&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
     <span style="color:#e6db74">&#34;@timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; 2022-01-26T17:31:50.864Z,
        <span style="color:#e6db74">&#34;request&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/resources/jquery.min.js&#34;</span>,
      <span style="color:#e6db74">&#34;useragent&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
           <span style="color:#e6db74">&#34;os_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Windows&#34;</span>,
           <span style="color:#e6db74">&#34;os_full&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Windows 10&#34;</span>,
             <span style="color:#e6db74">&#34;patch&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;4692&#34;</span>,
              <span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Chrome&#34;</span>,
        <span style="color:#e6db74">&#34;os_version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;10&#34;</span>,
            <span style="color:#e6db74">&#34;device&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Other&#34;</span>,
           <span style="color:#e6db74">&#34;version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;97.0.4692.71&#34;</span>,
             <span style="color:#e6db74">&#34;minor&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;0&#34;</span>,
                <span style="color:#e6db74">&#34;os&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Windows&#34;</span>,
          <span style="color:#e6db74">&#34;os_major&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;10&#34;</span>,
             <span style="color:#e6db74">&#34;major&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;97&#34;</span>
    <span style="color:#f92672">}</span>,
      <span style="color:#e6db74">&#34;timestamp&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;09/Jan/2022:17:52:49 +0900&#34;</span>,
           <span style="color:#e6db74">&#34;host&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;localhost&#34;</span>,
       <span style="color:#e6db74">&#34;@version&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1&#34;</span>,
           <span style="color:#e6db74">&#34;verb&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;GET&#34;</span>,
          <span style="color:#e6db74">&#34;bytes&#34;</span> <span style="color:#f92672">=</span>&gt; 299,
          <span style="color:#e6db74">&#34;geoip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
             <span style="color:#e6db74">&#34;longitude&#34;</span> <span style="color:#f92672">=</span>&gt; 126.9754,
                    <span style="color:#e6db74">&#34;ip&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;218.39.220.90&#34;</span>,
          <span style="color:#e6db74">&#34;country_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;South Korea&#34;</span>,
        <span style="color:#e6db74">&#34;continent_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;AS&#34;</span>,
           <span style="color:#e6db74">&#34;postal_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;04524&#34;</span>,
              <span style="color:#e6db74">&#34;location&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;lat&#34;</span> <span style="color:#f92672">=</span>&gt; 37.5794,
            <span style="color:#e6db74">&#34;lon&#34;</span> <span style="color:#f92672">=</span>&gt; 126.9754
        <span style="color:#f92672">}</span>,
         <span style="color:#e6db74">&#34;country_code2&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;KR&#34;</span>,
           <span style="color:#e6db74">&#34;region_code&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;11&#34;</span>,
              <span style="color:#e6db74">&#34;latitude&#34;</span> <span style="color:#f92672">=</span>&gt; 37.5794,
              <span style="color:#e6db74">&#34;timezone&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Asia/Seoul&#34;</span>,
           <span style="color:#e6db74">&#34;region_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Seoul&#34;</span>,
         <span style="color:#e6db74">&#34;country_code3&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;KR&#34;</span>,
             <span style="color:#e6db74">&#34;city_name&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Seoul&#34;</span>
    <span style="color:#f92672">}</span>,
           <span style="color:#e6db74">&#34;auth&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;-&#34;</span>,
       <span style="color:#e6db74">&#34;response&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;503&#34;</span>,
        <span style="color:#e6db74">&#34;logdate&#34;</span> <span style="color:#f92672">=</span>&gt; 2022-01-09T08:52:49.000Z,
    <span style="color:#e6db74">&#34;httpversion&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;1.1&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><!-- raw HTML omitted -->
<p>지금까지는 apache 로그의 첫번째 행을 읽어들이고 nc 명령으로 전송했었습니다.</p>
<p>이제는 nc 명령으로 전송하지 않고 filebeat 가 로그파일을 모두 읽고 logstash 로 전송하는 예시를 보겠습니다.</p>
<p>logstash 의 output 설정은 stdout 으로 출력과 elasticsearch 로 출력하도록 설정을 했습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ vi /etc/filebeat/filebeat.yml
<span style="color:#75715e">#- type: filestream</span>
- type: log
  enabled: true
    - /root/test/weblog.txt
<span style="color:#75715e">#output.elasticsearch:</span>
  <span style="color:#75715e">#hosts: [&#34;localhost:9200&#34;]</span>
output.logstash:
  hosts: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;localhost:5044&#34;</span><span style="color:#f92672">]</span>
$
<span style="color:#75715e"># index =&gt; &#34;mgkim-apache-log-%{+yyyy.MM.dd}&#34;</span>
<span style="color:#75715e"># @timestamp 의 값으로 %{+yyyy.MM.dd} 포맷의 index가 일자별로 생성됨</span>
$ vi exam_filter.ls
input <span style="color:#f92672">{</span>
  <span style="color:#75715e">#tcp {</span>
  <span style="color:#75715e">#  port =&gt; 9900</span>
  <span style="color:#75715e">#}</span>
  beats <span style="color:#f92672">{</span>
    port <span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">5044</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

filter <span style="color:#f92672">{</span>
  mutate <span style="color:#f92672">{</span>
    remove_field <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;agent&#34;</span><span style="color:#f92672">]</span>
  <span style="color:#f92672">}</span>
  grok <span style="color:#f92672">{</span>
    match <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;%{COMBINEDAPACHELOG}&#34;</span> <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  geoip <span style="color:#f92672">{</span>
    source <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;clientip&#34;</span>
  <span style="color:#f92672">}</span>
  mutate <span style="color:#f92672">{</span>
    convert <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;bytes&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;integer&#34;</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  useragent <span style="color:#f92672">{</span>
    source <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;agent&#34;</span>
    target <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;useragent&#34;</span>
  <span style="color:#f92672">}</span>
  date <span style="color:#f92672">{</span>
    match <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;timestamp&#34;</span>, <span style="color:#e6db74">&#34;dd/MMM/yyyy:HH:mm:ss Z&#34;</span><span style="color:#f92672">]</span>
  <span style="color:#f92672">}</span>
  mutate <span style="color:#f92672">{</span>
    remove_field <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;timestamp&#34;</span>, <span style="color:#e6db74">&#34;host&#34;</span>, <span style="color:#e6db74">&#34;@version&#34;</span>, <span style="color:#e6db74">&#34;agent&#34;</span><span style="color:#f92672">]</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
output <span style="color:#f92672">{</span>
  stdout <span style="color:#f92672">{</span>
    codec <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;dots&#34;</span>
  <span style="color:#f92672">}</span>
  elasticsearch <span style="color:#f92672">{</span>
    index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;mgkim-apache-log-%{+yyyy.MM.dd}&#34;</span>
    hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;centos8:9200&#34;</span><span style="color:#f92672">]</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
$ logstash -f exam_filter.ls --config.reload.automatic
$ systemctl stop filebeat
<span style="color:#75715e"># filebeat 가 한 번 읽어들인 정보는 data 디렉토리 /var/lib/filebeat/ 에 보관되어있습니다.</span>
<span style="color:#75715e"># 이 디렉토리의 모든 정보를 삭제하면 다시 읽어들입니다.</span>
$ rm -rf /var/lib/filebeat/*
$ systemctl start filebeat

</code></pre></div><p>losstash 에서 elasticsearch 로 출력한 내용은 kibana 에서 확인합니다.</p>
<p>kibana는 elasticsearch 의 클라이언트 tool 이라고 생각하면 됩니다.</p>
<p><!-- raw HTML omitted -->(비유를 해보면 oracle-dbms 는 elasticsearch 이고, sqldeveloper 는 kibana 입니다.)<!-- raw HTML omitted --></p>
<p>kibana 에서는 <code>Management</code> &gt; <code>Dev Tools</code> 메뉴로 이동하여 아래 코드를 통해 실행할 수 있습니다.</p>
<pre><code>get _cat/indices
get mgkim-apache-log-2022.01.09/_search
get mgkim-apache-log-2022.01.09/_count

</code></pre>
	
	
	<div class="text-muted mt-5 pt-3 border-top">

</div>

</div>


          </main>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>


<script src="https://cdn.jsdelivr.net/npm/mermaid@8.11.2/dist/mermaid.min.js" integrity="sha384-m8Pdaep6Qk8sW3J6XhPOiwUww3maU9HxZTLvEfSEB4e1UVvTdHyfJsYmEfYqvwLC" crossorigin="anonymous"></script>



<style>
.markmap > svg {
  width: 100%;
  height: 300px;
}
</style>
<script>
window.markmap = {
  autoLoader: { manual: true },
};
</script>
<script src="https://cdn.jsdelivr.net/npm/markmap-autoloader"></script>


<script src='/js/tabpane-persist.js'></script>



<script src='/js/deflate.js'></script>


 

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.min.css" integrity="sha384-Cqd8ihRLum0CCg8rz0hYKPoLZ3uw+gES2rXQXycqnL5pgVQIflxAUDS7ZSjITLb5" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.min.js" integrity="sha384-1Or6BdeNQb0ezrmtGeqQHFpppNd7a/gw29xeiSikBbsb44xu3uAo8c7FwbF5jhbd" crossorigin="anonymous"></script>
 


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/contrib/mhchem.min.js" integrity="sha384-LIgAiYlGSAdpNC9+YDjDPF6JeS/RRIumtNo0CmyQERZ/+g0h9MbuYQwf/5pQ4Y4M"  crossorigin="anonymous"></script>


<script defer src='https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/contrib/auto-render.min.js' integrity='sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl' crossorigin='anonymous' onload='renderMathInElement(document.body, null);'></script>














<script src="/js/main.min.c1b8f3c373b85f900699a7ea81c2038ebbbebcac1a5a4b6e5ef96c24c31790d6.js" integrity="sha256-wbjzw3O4X5AGmafqgcIDjru&#43;vKwaWktuXvlsJMMXkNY=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>