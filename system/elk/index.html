<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.87.0" /><META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>ELK | dlog</title>


  
  <meta name="description" content="elasticsearch 설치
artifacts.elastic.co 에서 rpm 다운로드 후 설치
$ curl -L -O …">
<meta property="og:title" content="ELK" />
<meta property="og:description" content="elasticsearch 설치 artifacts.elastic.co 에서 rpm 다운로드 후 설치
$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.16.3-x86_64.rpm $ rpm -i elasticsearch-7.16.3-x86_64.rpm $ systemctl restart elasticsearch $ curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-7.16.3-linux-x86_64.tar.gz $ rpm -i elasticsearch-7.16.3-x86_64.rpm 경고: elasticsearch-7.16.3-x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID d88e42b4: NOKEY Creating elasticsearch group... OK Creating elasticsearch user... OK ### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd sudo systemctl daemon-reload sudo systemctl enable elasticsearch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/system/elk/" /><meta property="article:section" content="system" />



<meta itemprop="name" content="ELK">
<meta itemprop="description" content="elasticsearch 설치 artifacts.elastic.co 에서 rpm 다운로드 후 설치
$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.16.3-x86_64.rpm $ rpm -i elasticsearch-7.16.3-x86_64.rpm $ systemctl restart elasticsearch $ curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-7.16.3-linux-x86_64.tar.gz $ rpm -i elasticsearch-7.16.3-x86_64.rpm 경고: elasticsearch-7.16.3-x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID d88e42b4: NOKEY Creating elasticsearch group... OK Creating elasticsearch user... OK ### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd sudo systemctl daemon-reload sudo systemctl enable elasticsearch.">

<meta itemprop="wordCount" content="4020">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ELK"/>
<meta name="twitter:description" content="elasticsearch 설치 artifacts.elastic.co 에서 rpm 다운로드 후 설치
$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.16.3-x86_64.rpm $ rpm -i elasticsearch-7.16.3-x86_64.rpm $ systemctl restart elasticsearch $ curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-7.16.3-linux-x86_64.tar.gz $ rpm -i elasticsearch-7.16.3-x86_64.rpm 경고: elasticsearch-7.16.3-x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID d88e42b4: NOKEY Creating elasticsearch group... OK Creating elasticsearch user... OK ### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd sudo systemctl daemon-reload sudo systemctl enable elasticsearch."/>




<link rel="preload" href="/scss/main.min.7bab5b53ce3a6e9d0beb97d70df0f5bd91bedfa2f6e2037ec8f9d3b5e3f7a384.css" as="style">
<link href="/scss/main.min.7bab5b53ce3a6e9d0beb97d70df0f5bd91bedfa2f6e2037ec8f9d3b5e3f7a384.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>










  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">dlog</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/system/" ><i class='fas fa-book'></i><span class="active">system</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/localenv/" ><i class='fas fa-book'></i><span>localenv</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.88651a633238024d978d6574636c7bdb.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.88651a633238024d978d6574636c7bdb.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>


    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-system-li">
  
  <a href="/system/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-system"><span class="">system</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemcentos8-li">
  
  <a href="/system/centos8/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemcentos8"><span class="">centos8</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-systemelk-li">
  
  <a href="/system/elk/" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id="m-systemelk"><span class="td-sidebar-nav-active-item">ELK</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemhttpd-li">
  
  <a href="/system/httpd/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemhttpd"><span class="">httpd</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemjenkins-li">
  
  <a href="/system/jenkins/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemjenkins"><span class="">jenkins</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemkibana-li">
  
  <a href="/system/kibana/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemkibana"><span class="">kibana</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemlinux-li">
  
  <a href="/system/linux/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemlinux"><span class="">linux</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemopenssh-li">
  
  <a href="/system/openssh/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemopenssh"><span class="">openssh</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-systemoracle12c-li">
  
  <a href="/system/oracle12c/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-systemoracle12c"><span class="">oracle12c</span></a>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
  
  
  
  
  
  
  <div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
  
  
  </div>


            


<div class="td-toc"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#elasticsearch-설치">elasticsearch 설치</a></li>
            <li><a href="#elasticsearch-설정">elasticsearch 설정</a></li>
            <li><a href="#kibana-설치-binary">kibana 설치 (binary)</a></li>
            <li><a href="#kibana-설치-yum">kibana 설치 (yum)</a></li>
            <li><a href="#kibana-설정-binary">kibana 설정 (binary)</a></li>
            <li><a href="#kibana-설정-yum">kibana 설정 (yum)</a></li>
            <li><a href="#logstash-설치">logstash 설치</a></li>
            <li><a href="#logstash-설정">logstash 설정</a></li>
            <li><a href="#logstash-설정-pipelinesyml">logstash 설정 (pipelines.yml)</a></li>
            <li><a href="#logstash-이해">logstash 이해</a></li>
            <li><a href="#filebeat-설치">filebeat 설치</a></li>
            <li><a href="#filebeat-설정">filebeat 설정</a></li>
            <li><a href="#filebeat-이해-filebeat-logstash-elastic">filebeat 이해 (filebeat-logstash-elastic)</a>
              <ul>
                <li><a href="#logstash-설정-1">logstash 설정</a></li>
                <li><a href="#filebeat-설정-1">filebeat 설정</a></li>
                <li><a href="#filebeat-logstash-테스트">filebeat-logstash 테스트</a></li>
                <li><a href="#filebeat-logstash-elastics-테스트">filebeat-logstash-elastics 테스트</a></li>
                <li><a href="#logstash-설정-keystore">logstash 설정 (keystore)</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>



            

	
		



  
  

	
		



  
  

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		







<li class="breadcrumb-item" >
	<a href="/system/">system</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/system/elk/">ELK</a>
</li>

	</ol>
</nav	>

            
<div class="td-content">
	<h1>ELK</h1>
	
	<header class="article-meta">
		
		
			
				


			
				


			
		
		
	</header>    
	<h4 id="elasticsearch-설치">elasticsearch 설치</h4>
<p><code>artifacts.elastic.co</code> 에서 rpm 다운로드 후 설치</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.16.3-x86_64.rpm
$ rpm -i elasticsearch-7.16.3-x86_64.rpm
$ systemctl restart elasticsearch
$ curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-7.16.3-linux-x86_64.tar.gz
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ rpm -i elasticsearch-7.16.3-x86_64.rpm
경고: elasticsearch-7.16.3-x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID d88e42b4: NOKEY
Creating elasticsearch group... OK
Creating elasticsearch user... OK
<span style="color:#8f5902;font-style:italic">### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd</span>
 sudo systemctl daemon-reload
 sudo systemctl <span style="color:#204a87">enable</span> elasticsearch.service
<span style="color:#8f5902;font-style:italic">### You can start elasticsearch service by executing</span>
 sudo systemctl start elasticsearch.service
warning: usage of JAVA_HOME is deprecated, use ES_JAVA_HOME
Created elasticsearch keystore in /etc/elasticsearch/elasticsearch.keystore
<span style="color:#ce5c00;font-weight:bold">[</span>/usr/lib/tmpfiles.d/elasticsearch.conf:1<span style="color:#ce5c00;font-weight:bold">]</span> Line references path below legacy directory /var/run/, updating /var/run/elasticsearch → /run/elasticsearch<span style="color:#000;font-weight:bold">;</span> please update the tmpfiles.d/ drop-in file accordingly.
$ curl http://127.0.0.1:9200
<span style="color:#ce5c00;font-weight:bold">{</span>
  <span style="color:#4e9a06">&#34;name&#34;</span> : <span style="color:#4e9a06">&#34;centos8&#34;</span>,
  <span style="color:#4e9a06">&#34;cluster_name&#34;</span> : <span style="color:#4e9a06">&#34;elasticsearch&#34;</span>,
  <span style="color:#4e9a06">&#34;cluster_uuid&#34;</span> : <span style="color:#4e9a06">&#34;_e3hsZBwTtS2aAyJvCfqbA&#34;</span>,
  <span style="color:#4e9a06">&#34;version&#34;</span> : <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#4e9a06">&#34;number&#34;</span> : <span style="color:#4e9a06">&#34;7.16.3&#34;</span>,
    <span style="color:#4e9a06">&#34;build_flavor&#34;</span> : <span style="color:#4e9a06">&#34;default&#34;</span>,
    <span style="color:#4e9a06">&#34;build_type&#34;</span> : <span style="color:#4e9a06">&#34;rpm&#34;</span>,
    <span style="color:#4e9a06">&#34;build_hash&#34;</span> : <span style="color:#4e9a06">&#34;4e6e4eab2297e949ec994e688dad46290d018022&#34;</span>,
    <span style="color:#4e9a06">&#34;build_date&#34;</span> : <span style="color:#4e9a06">&#34;2022-01-06T23:43:02.825887787Z&#34;</span>,
    <span style="color:#4e9a06">&#34;build_snapshot&#34;</span> : false,
    <span style="color:#4e9a06">&#34;lucene_version&#34;</span> : <span style="color:#4e9a06">&#34;8.10.1&#34;</span>,
    <span style="color:#4e9a06">&#34;minimum_wire_compatibility_version&#34;</span> : <span style="color:#4e9a06">&#34;6.8.0&#34;</span>,
    <span style="color:#4e9a06">&#34;minimum_index_compatibility_version&#34;</span> : <span style="color:#4e9a06">&#34;6.0.0-beta1&#34;</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>,
  <span style="color:#4e9a06">&#34;tagline&#34;</span> : <span style="color:#4e9a06">&#34;You Know, for Search&#34;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
$
</code></pre></div><br>
<h4 id="elasticsearch-설정">elasticsearch 설정</h4>
<p>설정 파일 <code>/etc/elasticsearch/elasticsearch.yml</code>에서 데이터/로그 디렉토리 변경</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#8f5902;font-style:italic">##</span>
$ mkdir -p /data/PROD/es <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chown elasticsearch:elasticsearch /data/PROD/es
$ mkdir -p /data/PROD/es <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chown elasticsearch:elasticsearch /outlog/PROD/es

<span style="color:#8f5902;font-style:italic">## </span>
 <span style="color:#0000cf;font-weight:bold">33</span> <span style="color:#8f5902;font-style:italic">#path.data: /var/lib/elasticsearch</span>
 <span style="color:#0000cf;font-weight:bold">34</span> path.data: /data/PROD/es
 <span style="color:#0000cf;font-weight:bold">38</span> <span style="color:#8f5902;font-style:italic">#path.logs: /var/log/elasticsearch</span>
 <span style="color:#0000cf;font-weight:bold">39</span> path.logs: /outlog/PROD/es
 <span style="color:#0000cf;font-weight:bold">58</span> <span style="color:#8f5902;font-style:italic">#network.host: 192.168.0.1</span>
 <span style="color:#0000cf;font-weight:bold">59</span> network.host: 0.0.0.0
 <span style="color:#0000cf;font-weight:bold">73</span> <span style="color:#8f5902;font-style:italic">#discovery.seed_hosts: [&#34;host1&#34;, &#34;host2&#34;]</span>
 <span style="color:#0000cf;font-weight:bold">74</span> discovery.seed_hosts: <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;0.0.0.0&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</code></pre></div><br>
<h4 id="kibana-설치-binary">kibana 설치 (binary)</h4>
<p><code>artifacts.elastic.co</code>에서 tar.gz 다운로드 후 아카이브 해제</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-7.16.3-linux-x86_64.tar.gz
$ tar zxvf kibana-7.16.3-linux-x86_64.tar.gz
$ mkdir -p /prod/kibana
$ mv kibana-7.16.3-linux-x86_64 /prod/kibana
$ <span style="color:#204a87">cd</span> /prod/kibana <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ln -s kibana-7.16.3-linux-x86_64 kibana
$ chown -R tomcat:ap /prod/kibana
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ tree -L <span style="color:#0000cf;font-weight:bold">2</span>
.
├── kibana -&gt; kibana-7.16.3-linux-x86_64/
└── kibana-7.16.3-linux-x86_64
    ├── LICENSE.txt
    ├── NOTICE.txt
    ├── README.txt
    ├── bin
    ├── config
    ├── data
    ├── node
    ├── node_modules
    ├── package.json
    ├── plugins
    ├── src
    └── x-pack

<span style="color:#0000cf;font-weight:bold">10</span> directories, <span style="color:#0000cf;font-weight:bold">4</span> files
$
</code></pre></div><br>
<h4 id="kibana-설치-yum">kibana 설치 (yum)</h4>
<p>PGP 를 추가합니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch
</code></pre></div><p><code>vi /etc/yum.repos.d/kibana.repo</code> 아래 내용을 추가합니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ce5c00;font-weight:bold">[</span>kibana-7.x<span style="color:#ce5c00;font-weight:bold">]</span>
<span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">=</span>Kibana repository <span style="color:#204a87;font-weight:bold">for</span> 7.x packages
<span style="color:#000">baseurl</span><span style="color:#ce5c00;font-weight:bold">=</span>https://artifacts.elastic.co/packages/7.x/yum
<span style="color:#000">gpgcheck</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
<span style="color:#000">gpgkey</span><span style="color:#ce5c00;font-weight:bold">=</span>https://artifacts.elastic.co/GPG-KEY-elasticsearch
<span style="color:#000">enabled</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
<span style="color:#000">autorefresh</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
<span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span>rpm-md
</code></pre></div><p>yum 으로 kibana 를 설치합니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ yum install kibana
</code></pre></div><p>systemd</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ systemctl <span style="color:#204a87">enable</span> kibana
$ systemctl start kibana
</code></pre></div><br>
<h4 id="kibana-설정-binary">kibana 설정 (binary)</h4>
<p>설정 파일 <code>/prod/kibana/kibana/config/kibana.yml</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#8f5902;font-style:italic"># 기본 설정 파일로 실행 시 `server.publicBaseUrl` 에 대한 경고가 표시 됩니다.</span>
<span style="color:#8f5902;font-style:italic"># &#34;server.publicBaseUrl&#34; 는 &#34;server.basePath&#34; 의 경로를 반드시 포함해야 합니다.</span>
 <span style="color:#0000cf;font-weight:bold">24</span> <span style="color:#8f5902;font-style:italic">#server.publicBaseUrl: &#34;&#34;</span>
 <span style="color:#0000cf;font-weight:bold">25</span> server.publicBaseUrl: <span style="color:#4e9a06">&#34;http://localhost:5601&#34;</span>
<span style="color:#8f5902;font-style:italic"># logging off</span>
 <span style="color:#0000cf;font-weight:bold">103</span> <span style="color:#8f5902;font-style:italic">#logging.silent: false</span>
 <span style="color:#0000cf;font-weight:bold">104</span> logging.silent: <span style="color:#204a87">true</span>
</code></pre></div><p><a href="https://www.elastic.co/guide/en/kibana/master/settings.html" target="_blank"><a href="http://www.elastic.co">www.elastic.co</a> kibana 설정 가이드</a></p>
<br>
<h4 id="kibana-설정-yum">kibana 설정 (yum)</h4>
<p>설정 파일 <code>/etc/kibana/kibana.yml</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">server.port: <span style="color:#0000cf;font-weight:bold">5601</span>
server.publicBaseUrl: <span style="color:#4e9a06">&#34;http://localhost:5601&#34;</span>
logging.silent: <span style="color:#204a87">true</span>
</code></pre></div><p><a href="https://www.elastic.co/guide/en/kibana/7.16/rpm.html#rpm-layout" target="_blank">rpm-layout</a></p>
<ul>
<li>설정: /etc/kibana</li>
<li>로그: /var/log/kibana</li>
<li>데이터: /var/lib/kibana</li>
</ul>
<p>로그 경로 변경 (<code>/var/log/kibana</code> &gt; <code>/outlog/PROD/kibana</code>)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ mkdir -p /outlog/PROD/kibana <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chown kibana:kibana /outlog/PROD/kibana
$ vi /etc/systemd/system/kibana.service
 <span style="color:#0000cf;font-weight:bold">18</span> <span style="color:#8f5902;font-style:italic">#ExecStart=/usr/share/kibana/bin/kibana --logging.dest=&#34;/var/log/kibana/kibana.log&#34; --pid.file=&#34;/run/kibana/kibana.pid&#34;</span>
 <span style="color:#0000cf;font-weight:bold">19</span> <span style="color:#000">ExecStart</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/share/kibana/bin/kibana --logging.dest<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/outlog/PROD/kibana/kibana.log&#34;</span> --pid.file<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/run/kibana/kibana.pid&#34;</span>
$ systemctl restart kibana
Warning: The unit file, <span style="color:#204a87">source</span> configuration file or drop-ins of kibana.service changed on disk. Run <span style="color:#4e9a06">&#39;systemctl daemon-reload&#39;</span> to reload units.

$ systemctl daemon-reload
$ systemctl restart kibana
</code></pre></div><br>
<p>httpd 가상호스트 설정</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">&lt;VirtualHost *:80&gt;
  ServerName kibana

  ErrorLog <span style="color:#4e9a06">&#34;|/usr/sbin/rotatelogs /outlog/WEB/httpd/kibana-error.log.%Y-%m-%d 86400 +540%&#34;</span>
  CustomLog <span style="color:#4e9a06">&#34;|/usr/sbin/rotatelogs /outlog/WEB/httpd/kibana-access.log.%Y-%m-%d 86400 +540%&#34;</span> combined

  AllowEncodedSlashes On
  Header <span style="color:#204a87">set</span> Access-Control-Allow-Origin <span style="color:#4e9a06">&#34;*&#34;</span>

  ProxyRequests Off
  ProxyPreserveHost On

  &lt;Proxy *&gt;
    Require all granted
  &lt;/Proxy&gt;

  ProxyPass / http://localhost:5601/        <span style="color:#8f5902;font-style:italic"># &#34;kibana.yml&#34; 파일 &#34;server.host&#34; 에 설정된 호스트로 할 것</span>
  ProxyPassReverse / http://localhost:5601/
&lt;/VirtualHost&gt;
</code></pre></div><br>
<p>kibana는 elasticsearch 와 connect 가 되지 않은 상태일 경우 <code>Kibana server is not ready yet</code> 메시지가 표시됩니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">#/etc/kibana/kibana.yml
#elasticsearch.hosts: [&#34;http://localhost:9200&#34;]
elasticsearch.hosts: [&#34;http://localhost:8200&#34;]
</code></pre></div><br>
<h4 id="logstash-설치">logstash 설치</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ yum install logstash
</code></pre></div><p>systemd</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ systemctl <span style="color:#204a87">enable</span> logstash
$ systemctl start logstash
</code></pre></div><br>
<h4 id="logstash-설정">logstash 설정</h4>
<p>데이터 경로<code>path.data</code>, log 경로<code>path.logs</code>를 변경합니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ mkdir -p /outlog/PROD/logstash <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chown logstash:logstash /outlog/PROD/logstash
$ vi /etc/logstash/logstash.yml
 <span style="color:#0000cf;font-weight:bold">28</span> <span style="color:#8f5902;font-style:italic">#path.data: /var/lib/logstash</span>
 <span style="color:#0000cf;font-weight:bold">29</span> path.data: /data/PROD/logstash
 <span style="color:#0000cf;font-weight:bold">87</span> <span style="color:#8f5902;font-style:italic"># config.reload.automatic: false</span>
 <span style="color:#0000cf;font-weight:bold">88</span> config.reload.automatic: <span style="color:#204a87">true</span>
 <span style="color:#0000cf;font-weight:bold">95</span> <span style="color:#8f5902;font-style:italic"># config.reload.interval: 3s</span>
 <span style="color:#0000cf;font-weight:bold">96</span> config.reload.interval: 1s
<span style="color:#0000cf;font-weight:bold">269</span> <span style="color:#8f5902;font-style:italic">#path.logs: /var/log/logstash</span>
<span style="color:#0000cf;font-weight:bold">270</span> path.logs: /outlog/PROD/logstash

$ mkdir /data/PROD/logstash <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chown logstash:logstash /data/PROD/logstash
$ mkdir /outlog/PROD/logstash <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chown logstash:logstash /outlog/PROD/logstash
</code></pre></div><p>logstash 서비스는 pipelines.yml 의 conf 파일 설정이 되었을때 start 를 하는 것을 권합니다.</p>
<p>conf 파일이 없을 경우 <code>config.reload.automatic: true</code>에 의해 <code>config.reload.interval: 1s</code> 마다 아래와 같은 로그가 <code>/outlog/PROD/logstash/logstash-plain.log</code> 파일에 출력됩니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">[2022-01-28T11:09:33,537][INFO ][logstash.config.source.local.configpathloader] No config files found in path {:path=&gt;&#34;/etc/logstash/conf.d/*.conf&#34;}
[2022-01-28T11:09:33,539][ERROR][logstash.config.sourceloader] No configuration found in the configured sources.
</code></pre></div><br>
<h4 id="logstash-설정-pipelinesyml">logstash 설정 (pipelines.yml)</h4>
<p>logstash 는 <code>/etc/logstash/pipelines.yml</code> 에는 conf 파일(<code>input-filter-output</code> 처리를 정의한 파일)의 경로를 설정합니다.</p>
<p>기본 설치된 <code>pipelines.yml</code> 내용을 보면 다음과 같습니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ cat /etc/logstash/pipelines.yml
# This file is where you define your pipelines. You can define multiple.
# For more information on multiple pipelines, see the documentation:
#   https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html

- pipeline.id: main
  path.config: &#34;/etc/logstash/conf.d/*.conf&#34;
</code></pre></div><p>아래와 같이 설정 파일을 추가하면 <code>config.reload.automatic: true</code> 설정에 의해 자동으로 conf 파일을 reload 합니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ cat &lt;&lt; EOF &gt; /etc/logstash/conf.d/exam_tcp.conf
input {
  tcp {
    port =&gt; 10000
  }
}

output {
  stdout {}
}
EOF
$ 
$ ls -al /etc/logstash/conf.d/exam_tcp.conf
-rw-r--r-- 1 root root 77 2022-01-28 01:59 /etc/logstash/conf.d/exam_tcp.conf
$ 
</code></pre></div><p><code>exam_tcp.conf</code> 파일을 추가했을 때와 port 를 10000 에서 10001 로 변경했을 때에 대한 로그입니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">[2022-01-28T11:09:35,939][INFO ][logstash.javapipeline    ][main] Starting pipeline {:pipeline_id=&gt;&#34;main&#34;, &#34;pipeline.workers&#34;=&gt;4, &#34;pipeline.batch.size&#34;=&gt;125, &#34;pipeline.batch.delay&#34;=&gt;50, &#34;pipeline.max_inflight&#34;=&gt;500, &#34;pipeline.sources&#34;=&gt;[&#34;/etc/logstash/conf.d/exam_tcp.conf&#34;], :thread=&gt;&#34;#&lt;Thread:0x9fd78a8 run&gt;&#34;}
[2022-01-28T11:09:35,967][INFO ][logstash.javapipeline    ][main] Pipeline Java execution initialization time {&#34;seconds&#34;=&gt;0.03}
[2022-01-28T11:09:35,982][INFO ][logstash.javapipeline    ][main] Pipeline started {&#34;pipeline.id&#34;=&gt;&#34;main&#34;}
[2022-01-28T11:09:35,984][INFO ][logstash.inputs.tcp      ][main][d83c273d53113db5c7c05a26049443aedcdfcd34e3deae0d6abd509db45a5e87] Starting tcp input listener {:address=&gt;&#34;0.0.0.0:10000&#34;, :ssl_enable=&gt;false}
[2022-01-28T11:09:35,987][INFO ][logstash.agent           ] Pipelines running {:count=&gt;1, :running_pipelines=&gt;[:main], :non_running_pipelines=&gt;[]}

[2022-01-28T11:10:40,988][INFO ][logstash.pipelineaction.reload] Reloading pipeline {&#34;pipeline.id&#34;=&gt;:main}
[2022-01-28T11:10:45,149][INFO ][logstash.javapipeline    ][main] Pipeline terminated {&#34;pipeline.id&#34;=&gt;&#34;main&#34;}
[2022-01-28T11:10:46,510][INFO ][logstash.javapipeline    ][main] Starting pipeline {:pipeline_id=&gt;&#34;main&#34;, &#34;pipeline.workers&#34;=&gt;4, &#34;pipeline.batch.size&#34;=&gt;125, &#34;pipeline.batch.delay&#34;=&gt;50, &#34;pipeline.max_inflight&#34;=&gt;500, &#34;pipeline.sources&#34;=&gt;[&#34;/etc/logstash/conf.d/exam_tcp.conf&#34;], :thread=&gt;&#34;#&lt;Thread:0x58a6a0d5 run&gt;&#34;}
[2022-01-28T11:10:46,529][INFO ][logstash.javapipeline    ][main] Pipeline Java execution initialization time {&#34;seconds&#34;=&gt;0.02}
[2022-01-28T11:10:46,543][INFO ][logstash.javapipeline    ][main] Pipeline started {&#34;pipeline.id&#34;=&gt;&#34;main&#34;}
[2022-01-28T11:10:46,543][INFO ][logstash.inputs.tcp      ][main][735f4ed1b2193b470c8f3f5019940dab9a73e81dbd8046b87dd2d15ff6bf5850] Starting tcp input listener {:address=&gt;&#34;0.0.0.0:10001&#34;, :ssl_enable=&gt;false}
[2022-01-28T11:10:46,559][INFO ][logstash.agent           ] Pipelines running {:count=&gt;1, :running_pipelines=&gt;[:main], :non_running_pipelines=&gt;[]}
</code></pre></div><br>
<h4 id="logstash-이해">logstash 이해</h4>
<p>실행파일<code>/usr/share/logstash/bin/logstash</code>이 PATH 에 추가하는 것을 권합니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">export</span> <span style="color:#000">LOGSTASH_HOME</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/share/logstash
<span style="color:#204a87">export</span> <span style="color:#000">PATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$PATH</span>:/usr/local/go/bin:<span style="color:#000">$LOGSTASH_HOME</span>/bin
</code></pre></div><p>logstash 가 동작하는 방식을 이해하기 위한 단계별 예시입니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#8f5902;font-style:italic"># logstash daemon 을 실행합니다.</span>
<span style="color:#8f5902;font-style:italic"># -e 파라미터에는 매우 단순한 표준 입출력을 정의했습니다.</span>
<span style="color:#8f5902;font-style:italic"># daemon </span>
$ logstash -e <span style="color:#4e9a06">&#39;
</span><span style="color:#4e9a06">input {
</span><span style="color:#4e9a06">  stdin {}
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">output {
</span><span style="color:#4e9a06">  stdout {}
</span><span style="color:#4e9a06">}&#39;</span>
</code></pre></div><br>
<p>별도의 터미널을 열고 logstash 9900 에 &ldquo;hello logstash&rdquo; 문자열을 nc(netcat)명령어로 전송해봅니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;hello logstash&#34;</span> <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">9900</span>
</code></pre></div><p>logstash 콘솔에서는 &ldquo;hello logstash&rdquo; 문자열을 stdout 으로 출력한 문자열을 볼 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">{
      &#34;@version&#34; =&gt; &#34;1&#34;,
          &#34;host&#34; =&gt; &#34;localhost&#34;,
          &#34;port&#34; =&gt; 64924,
       &#34;message&#34; =&gt; &#34;hello logstash&#34;,
    &#34;@timestamp&#34; =&gt; 2022-01-26T16:20:17.308Z
}
</code></pre></div><p>exam_tpc.ls 라는 텍스트 파일을 생성하고 logstash daemon 을 실행합니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cat <span style="color:#4e9a06">&lt;&lt; EOF &gt; exam_tcp.ls
</span><span style="color:#4e9a06">input {
</span><span style="color:#4e9a06">  tcp {
</span><span style="color:#4e9a06">    port =&gt; 9900
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">output {
</span><span style="color:#4e9a06">  stdout {}
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">EOF</span>
$ logstash -f exam_tcp.ls
</code></pre></div><p>nc 명령으로 &ldquo;hello&rdquo; 문자열을 전송해봅니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;hello&#34;</span> <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">9900</span>
<span style="color:#ce5c00;font-weight:bold">{</span>
      <span style="color:#4e9a06">&#34;@version&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1&#34;</span>,
          <span style="color:#4e9a06">&#34;host&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;localhost&#34;</span>,
          <span style="color:#4e9a06">&#34;port&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 64924,
       <span style="color:#4e9a06">&#34;message&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;hello&#34;</span>,
    <span style="color:#4e9a06">&#34;@timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 2022-01-26T16:30:27.908Z
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>logstash -f filename</code> 형태로 실행했을 경우 <code>filename</code>에 변경이 있을 경우 자동으로 reload 하는 옵션을 추가 합니다.</p>
<p>(logstash 를 systemctl 서비스로 실행하는 방식이 아니기에 아래 옵션을 추가해야 합니다.)</p>
<p><code>logstash -f filename --config.reload.automatic</code></p>
<p>apache access 로그파일을 하나 준비합니다.</p>
<p>(참고로 apache 로그파일의 레이아웃은 기본이어야 합니다.)</p>
<p>로그파일의 1번째 행을 읽어들이고 9900 으로 전송하고 logstash 에서 처리한 로그를 확인합니다.</p>
<p>&ldquo;message&rdquo; 필드에 보낸 문자열을 출력하고 있는 점을 확인하면 됩니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cp /outlog/WEB/httpd/dwww-access.log.2022-01-09 weblog.txt
$ head -n <span style="color:#0000cf;font-weight:bold">1</span> weblog.txt  <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">9900</span>
<span style="color:#ce5c00;font-weight:bold">{</span>
          <span style="color:#4e9a06">&#34;port&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 65366,
      <span style="color:#4e9a06">&#34;@version&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1&#34;</span>,
          <span style="color:#4e9a06">&#34;host&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;localhost&#34;</span>,
       <span style="color:#4e9a06">&#34;message&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
    <span style="color:#4e9a06">&#34;@timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 2022-01-26T16:48:45.155Z
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>이번에는 exam_filter.ls 파일을 생성하고, filter 에 <code>grok</code>을 이용하여 &ldquo;message&rdquo; 필드를 parsing 해보겠습니다.</p>
<p><code>grok</code> 에 대한 설명은 아래 링크로 대체합니다.</p>
<p><a href="https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/ecs-v1/httpd">새 창 보기</a></p>
<p><code>grok-filter</code>에 의해 message 가 parsing 된 결과를 확인할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ logstash -f exam_filter.ls

$ cat <span style="color:#4e9a06">&lt;&lt; EOF &gt; exam_filter.ls
</span><span style="color:#4e9a06">input {
</span><span style="color:#4e9a06">  tcp {
</span><span style="color:#4e9a06">    port =&gt; 9900
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">
</span><span style="color:#4e9a06">filter {
</span><span style="color:#4e9a06">  grok {
</span><span style="color:#4e9a06">    match =&gt; { &#34;message&#34; =&gt; &#34;%{COMBINEDAPACHELOG}&#34; }
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">output {
</span><span style="color:#4e9a06">  stdout {}
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">EOF</span>
$ 
$ head -n <span style="color:#0000cf;font-weight:bold">1</span> weblog.txt <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">9900</span>
<span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#4e9a06">&#34;httpversion&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1.1&#34;</span>,
           <span style="color:#4e9a06">&#34;host&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;localhost&#34;</span>,
        <span style="color:#4e9a06">&#34;message&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
       <span style="color:#4e9a06">&#34;referrer&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;\&#34;http://dwww/status.html\&#34;&#34;</span>,
          <span style="color:#4e9a06">&#34;agent&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;\&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
          <span style="color:#4e9a06">&#34;ident&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;-&#34;</span>,
       <span style="color:#4e9a06">&#34;@version&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1&#34;</span>,
       <span style="color:#4e9a06">&#34;clientip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90&#34;</span>,
          <span style="color:#4e9a06">&#34;bytes&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;299&#34;</span>,
      <span style="color:#4e9a06">&#34;timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;09/Jan/2022:17:52:49 +0900&#34;</span>,
           <span style="color:#4e9a06">&#34;auth&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;-&#34;</span>,
     <span style="color:#4e9a06">&#34;@timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 2022-01-26T16:59:54.543Z,
       <span style="color:#4e9a06">&#34;response&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;503&#34;</span>,
           <span style="color:#4e9a06">&#34;port&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 9122,
           <span style="color:#4e9a06">&#34;verb&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;GET&#34;</span>,
        <span style="color:#4e9a06">&#34;request&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;/resources/jquery.min.js&#34;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>grok-filter</code>에서 parsing 되어 생성된 필드인 <code>&quot;clientip&quot;</code>를 <code>geoip-filter</code>가 처리할 수 있도록 설정하고 테스트 해봅니다.</p>
<p><code>geoip-filter</code>는 <code>grok-filter</code> 다음에 정의해야 한다는 것을 이해해야 합니다.</p>
<p>처리 결과에 geoip 라는 필드에 하위 세부 정보가 출력되는 것을 확인할 수 있습니다.</p>
<p>geoip 에 대한 설명은 아래 링크로 대체 합니다.</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.0/geoip-processor.html#using-ingest-geoip">새 창 보기</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#8f5902;font-style:italic"># grok 에서 parsing 된 정보 중 clientip 필드를 geoip 필터에 전달한다는 의미</span>
$ cat <span style="color:#4e9a06">&lt;&lt; EOF &gt; exam_filter.ls
</span><span style="color:#4e9a06">input {
</span><span style="color:#4e9a06">  tcp {
</span><span style="color:#4e9a06">    port =&gt; 9900
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">filter {
</span><span style="color:#4e9a06">  grok {
</span><span style="color:#4e9a06">    match =&gt; { &#34;message&#34; =&gt; &#34;%{COMBINEDAPACHELOG}&#34; }
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">  geoip {
</span><span style="color:#4e9a06">    source =&gt; &#34;clientip&#34;
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">output {
</span><span style="color:#4e9a06">  stdout {}
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">EOF</span>
$ 
$ head -n <span style="color:#0000cf;font-weight:bold">1</span> weblog.txt <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">9900</span>
<span style="color:#ce5c00;font-weight:bold">{</span>
           <span style="color:#4e9a06">&#34;auth&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;-&#34;</span>,
     <span style="color:#4e9a06">&#34;@timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 2022-01-26T17:08:31.046Z,
       <span style="color:#4e9a06">&#34;response&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;503&#34;</span>,
        <span style="color:#4e9a06">&#34;message&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
           <span style="color:#4e9a06">&#34;port&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 9306,
          <span style="color:#4e9a06">&#34;ident&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;-&#34;</span>,
          <span style="color:#4e9a06">&#34;agent&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;\&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
           <span style="color:#4e9a06">&#34;host&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;localhost&#34;</span>,
        <span style="color:#4e9a06">&#34;request&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;/resources/jquery.min.js&#34;</span>,
       <span style="color:#4e9a06">&#34;@version&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1&#34;</span>,
           <span style="color:#4e9a06">&#34;verb&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;GET&#34;</span>,
          <span style="color:#4e9a06">&#34;geoip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
             <span style="color:#4e9a06">&#34;longitude&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 126.9754,
         <span style="color:#4e9a06">&#34;country_code3&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;KR&#34;</span>,
           <span style="color:#4e9a06">&#34;region_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;11&#34;</span>,
             <span style="color:#4e9a06">&#34;city_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Seoul&#34;</span>,
          <span style="color:#4e9a06">&#34;country_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;South Korea&#34;</span>,
           <span style="color:#4e9a06">&#34;region_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Seoul&#34;</span>,
              <span style="color:#4e9a06">&#34;location&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#4e9a06">&#34;lat&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 37.5794,
            <span style="color:#4e9a06">&#34;lon&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 126.9754
        <span style="color:#ce5c00;font-weight:bold">}</span>,
              <span style="color:#4e9a06">&#34;latitude&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 37.5794,
        <span style="color:#4e9a06">&#34;continent_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;AS&#34;</span>,
         <span style="color:#4e9a06">&#34;country_code2&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;KR&#34;</span>,
           <span style="color:#4e9a06">&#34;postal_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;04524&#34;</span>,
                    <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90&#34;</span>,
              <span style="color:#4e9a06">&#34;timezone&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Asia/Seoul&#34;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>,
      <span style="color:#4e9a06">&#34;timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;09/Jan/2022:17:52:49 +0900&#34;</span>,
          <span style="color:#4e9a06">&#34;bytes&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;299&#34;</span>,
       <span style="color:#4e9a06">&#34;referrer&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;\&#34;http://dwww/status.html\&#34;&#34;</span>,
    <span style="color:#4e9a06">&#34;httpversion&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1.1&#34;</span>,
       <span style="color:#4e9a06">&#34;clientip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90&#34;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>logstash 의 output 으로 나오는 항목들은 모두 문자열입니다.</p>
<p>결과 필드를 정수(integer)형으로 변환하는 기능을 추가합니다.</p>
<p>filter 에 <code>mutate</code> 를 보면 됩니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cat <span style="color:#4e9a06">&lt;&lt; EOF &gt; exam_filter.ls
</span><span style="color:#4e9a06">input {
</span><span style="color:#4e9a06">  tcp {
</span><span style="color:#4e9a06">    port =&gt; 9900
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">filter {
</span><span style="color:#4e9a06">  grok {
</span><span style="color:#4e9a06">    match =&gt; { &#34;message&#34; =&gt; &#34;%{COMBINEDAPACHELOG}&#34; }
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">  geoip {
</span><span style="color:#4e9a06">    source =&gt; &#34;clientip&#34;
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">  mutate {
</span><span style="color:#4e9a06">    convert =&gt; {
</span><span style="color:#4e9a06">      &#34;bytes&#34; =&gt; &#34;integer&#34;
</span><span style="color:#4e9a06">    }
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">output {
</span><span style="color:#4e9a06">  stdout {}
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">EOF</span>
$ 
$ head -n <span style="color:#0000cf;font-weight:bold">1</span> weblog.txt <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">9900</span>
<span style="color:#ce5c00;font-weight:bold">{</span>
           <span style="color:#4e9a06">&#34;auth&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;-&#34;</span>,
           <span style="color:#4e9a06">&#34;host&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;localhost&#34;</span>,
       <span style="color:#4e9a06">&#34;response&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;503&#34;</span>,
           <span style="color:#4e9a06">&#34;verb&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;GET&#34;</span>,
        <span style="color:#4e9a06">&#34;message&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
           <span style="color:#4e9a06">&#34;port&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 9540,
          <span style="color:#4e9a06">&#34;bytes&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 299,
          <span style="color:#4e9a06">&#34;geoip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#4e9a06">&#34;continent_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;AS&#34;</span>,
           <span style="color:#4e9a06">&#34;region_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Seoul&#34;</span>,
           <span style="color:#4e9a06">&#34;postal_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;04524&#34;</span>,
              <span style="color:#4e9a06">&#34;timezone&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Asia/Seoul&#34;</span>,
         <span style="color:#4e9a06">&#34;country_code3&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;KR&#34;</span>,
          <span style="color:#4e9a06">&#34;country_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;South Korea&#34;</span>,
                    <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90&#34;</span>,
           <span style="color:#4e9a06">&#34;region_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;11&#34;</span>,
             <span style="color:#4e9a06">&#34;city_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Seoul&#34;</span>,
              <span style="color:#4e9a06">&#34;latitude&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 37.5794,
         <span style="color:#4e9a06">&#34;country_code2&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;KR&#34;</span>,
             <span style="color:#4e9a06">&#34;longitude&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 126.9754,
              <span style="color:#4e9a06">&#34;location&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#4e9a06">&#34;lat&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 37.5794,
            <span style="color:#4e9a06">&#34;lon&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 126.9754
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>,
          <span style="color:#4e9a06">&#34;ident&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;-&#34;</span>,
     <span style="color:#4e9a06">&#34;@timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 2022-01-26T17:19:32.250Z,
       <span style="color:#4e9a06">&#34;@version&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1&#34;</span>,
      <span style="color:#4e9a06">&#34;timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;09/Jan/2022:17:52:49 +0900&#34;</span>,
          <span style="color:#4e9a06">&#34;agent&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;\&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
        <span style="color:#4e9a06">&#34;request&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;/resources/jquery.min.js&#34;</span>,
       <span style="color:#4e9a06">&#34;clientip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90&#34;</span>,
       <span style="color:#4e9a06">&#34;referrer&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;\&#34;http://dwww/status.html\&#34;&#34;</span>,
    <span style="color:#4e9a06">&#34;httpversion&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1.1&#34;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>useragent</code>라는 filter 가 있습니다.</p>
<p>apache log 에 기본 포함되어있는 &ldquo;agent&rdquo; 필드를 parsing 하여 세분화합니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cat <span style="color:#4e9a06">&lt;&lt; EOF &gt; exam_filter.ls
</span><span style="color:#4e9a06">input {
</span><span style="color:#4e9a06">  tcp {
</span><span style="color:#4e9a06">    port =&gt; 9900
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">filter {
</span><span style="color:#4e9a06">  grok {
</span><span style="color:#4e9a06">    match =&gt; { &#34;message&#34; =&gt; &#34;%{COMBINEDAPACHELOG}&#34; }
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">  geoip {
</span><span style="color:#4e9a06">    source =&gt; &#34;clientip&#34;
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">  mutate {
</span><span style="color:#4e9a06">    convert =&gt; {
</span><span style="color:#4e9a06">      &#34;bytes&#34; =&gt; &#34;integer&#34;
</span><span style="color:#4e9a06">    }
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">  useragent {
</span><span style="color:#4e9a06">    source =&gt; &#34;agent&#34;
</span><span style="color:#4e9a06">    target =&gt; &#34;useragent&#34;
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">output {
</span><span style="color:#4e9a06">  stdout {}
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">EOF</span>
$ 
$ head -n <span style="color:#0000cf;font-weight:bold">1</span> weblog.txt <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">9900</span>
<span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#4e9a06">&#34;request&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;/resources/jquery.min.js&#34;</span>,
          <span style="color:#4e9a06">&#34;bytes&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 299,
        <span style="color:#4e9a06">&#34;message&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
          <span style="color:#4e9a06">&#34;ident&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;-&#34;</span>,
    <span style="color:#4e9a06">&#34;httpversion&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1.1&#34;</span>,
          <span style="color:#4e9a06">&#34;geoip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
           <span style="color:#4e9a06">&#34;postal_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;04524&#34;</span>,
             <span style="color:#4e9a06">&#34;city_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Seoul&#34;</span>,
        <span style="color:#4e9a06">&#34;continent_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;AS&#34;</span>,
          <span style="color:#4e9a06">&#34;country_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;South Korea&#34;</span>,
           <span style="color:#4e9a06">&#34;region_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;11&#34;</span>,
              <span style="color:#4e9a06">&#34;timezone&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Asia/Seoul&#34;</span>,
         <span style="color:#4e9a06">&#34;country_code2&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;KR&#34;</span>,
         <span style="color:#4e9a06">&#34;country_code3&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;KR&#34;</span>,
              <span style="color:#4e9a06">&#34;location&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#4e9a06">&#34;lat&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 37.5794,
            <span style="color:#4e9a06">&#34;lon&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 126.9754
        <span style="color:#ce5c00;font-weight:bold">}</span>,
           <span style="color:#4e9a06">&#34;region_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Seoul&#34;</span>,
             <span style="color:#4e9a06">&#34;longitude&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 126.9754,
              <span style="color:#4e9a06">&#34;latitude&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 37.5794,
                    <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90&#34;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>,
           <span style="color:#4e9a06">&#34;auth&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;-&#34;</span>,
       <span style="color:#4e9a06">&#34;referrer&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;\&#34;http://dwww/status.html\&#34;&#34;</span>,
       <span style="color:#4e9a06">&#34;response&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;503&#34;</span>,
      <span style="color:#4e9a06">&#34;useragent&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
          <span style="color:#4e9a06">&#34;os_major&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;10&#34;</span>,
        <span style="color:#4e9a06">&#34;os_version&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;10&#34;</span>,
           <span style="color:#4e9a06">&#34;os_full&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Windows 10&#34;</span>,
             <span style="color:#4e9a06">&#34;minor&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;0&#34;</span>,
                <span style="color:#4e9a06">&#34;os&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Windows&#34;</span>,
              <span style="color:#4e9a06">&#34;name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Chrome&#34;</span>,
             <span style="color:#4e9a06">&#34;patch&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;4692&#34;</span>,
             <span style="color:#4e9a06">&#34;major&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;97&#34;</span>,
           <span style="color:#4e9a06">&#34;version&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;97.0.4692.71&#34;</span>,
           <span style="color:#4e9a06">&#34;os_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Windows&#34;</span>,
            <span style="color:#4e9a06">&#34;device&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Other&#34;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>,
           <span style="color:#4e9a06">&#34;verb&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;GET&#34;</span>,
     <span style="color:#4e9a06">&#34;@timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 2022-01-26T17:23:55.151Z,
      <span style="color:#4e9a06">&#34;timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;09/Jan/2022:17:52:49 +0900&#34;</span>,
           <span style="color:#4e9a06">&#34;host&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;localhost&#34;</span>,
          <span style="color:#4e9a06">&#34;agent&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;\&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
       <span style="color:#4e9a06">&#34;@version&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1&#34;</span>,
           <span style="color:#4e9a06">&#34;port&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 9638,
       <span style="color:#4e9a06">&#34;clientip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90&#34;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>date</code> filter 입니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cat <span style="color:#4e9a06">&lt;&lt; EOF &gt; exam_filter.ls
</span><span style="color:#4e9a06">input {
</span><span style="color:#4e9a06">  tcp {
</span><span style="color:#4e9a06">    port =&gt; 9900
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">filter {
</span><span style="color:#4e9a06">  grok {
</span><span style="color:#4e9a06">    match =&gt; { &#34;message&#34; =&gt; &#34;%{COMBINEDAPACHELOG}&#34; }
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">  geoip {
</span><span style="color:#4e9a06">    source =&gt; &#34;clientip&#34;
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">  mutate {
</span><span style="color:#4e9a06">    convert =&gt; {
</span><span style="color:#4e9a06">      &#34;bytes&#34; =&gt; &#34;integer&#34;
</span><span style="color:#4e9a06">    }
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">  useragent {
</span><span style="color:#4e9a06">    source =&gt; &#34;agent&#34;
</span><span style="color:#4e9a06">    target =&gt; &#34;useragent&#34;
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">  date {
</span><span style="color:#4e9a06">    match =&gt; [&#34;timestamp&#34;, &#34;dd/MMM/yyyy:HH:mm:ss Z&#34;]
</span><span style="color:#4e9a06">    target =&gt; &#34;logdate&#34;
</span><span style="color:#4e9a06">  }
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">output {
</span><span style="color:#4e9a06">  stdout {}
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">EOF</span>
$ 
$ head -n <span style="color:#0000cf;font-weight:bold">1</span> weblog.txt <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">9900</span>
<span style="color:#ce5c00;font-weight:bold">{</span>
           <span style="color:#4e9a06">&#34;port&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 9818,
        <span style="color:#4e9a06">&#34;message&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90 - - [09/Jan/2022:17:52:49 +0900] \&#34;GET /resources/jquery.min.js HTTP/1.1\&#34; 503 299 \&#34;http://dwww/status.html\&#34; \&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
       <span style="color:#4e9a06">&#34;clientip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90&#34;</span>,
          <span style="color:#4e9a06">&#34;ident&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;-&#34;</span>,
       <span style="color:#4e9a06">&#34;referrer&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;\&#34;http://dwww/status.html\&#34;&#34;</span>,
          <span style="color:#4e9a06">&#34;agent&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;\&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\&#34;&#34;</span>,
     <span style="color:#4e9a06">&#34;@timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 2022-01-26T17:31:50.864Z,
        <span style="color:#4e9a06">&#34;request&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;/resources/jquery.min.js&#34;</span>,
      <span style="color:#4e9a06">&#34;useragent&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
           <span style="color:#4e9a06">&#34;os_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Windows&#34;</span>,
           <span style="color:#4e9a06">&#34;os_full&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Windows 10&#34;</span>,
             <span style="color:#4e9a06">&#34;patch&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;4692&#34;</span>,
              <span style="color:#4e9a06">&#34;name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Chrome&#34;</span>,
        <span style="color:#4e9a06">&#34;os_version&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;10&#34;</span>,
            <span style="color:#4e9a06">&#34;device&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Other&#34;</span>,
           <span style="color:#4e9a06">&#34;version&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;97.0.4692.71&#34;</span>,
             <span style="color:#4e9a06">&#34;minor&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;0&#34;</span>,
                <span style="color:#4e9a06">&#34;os&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Windows&#34;</span>,
          <span style="color:#4e9a06">&#34;os_major&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;10&#34;</span>,
             <span style="color:#4e9a06">&#34;major&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;97&#34;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>,
      <span style="color:#4e9a06">&#34;timestamp&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;09/Jan/2022:17:52:49 +0900&#34;</span>,
           <span style="color:#4e9a06">&#34;host&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;localhost&#34;</span>,
       <span style="color:#4e9a06">&#34;@version&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1&#34;</span>,
           <span style="color:#4e9a06">&#34;verb&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;GET&#34;</span>,
          <span style="color:#4e9a06">&#34;bytes&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 299,
          <span style="color:#4e9a06">&#34;geoip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
             <span style="color:#4e9a06">&#34;longitude&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 126.9754,
                    <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;218.39.220.90&#34;</span>,
          <span style="color:#4e9a06">&#34;country_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;South Korea&#34;</span>,
        <span style="color:#4e9a06">&#34;continent_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;AS&#34;</span>,
           <span style="color:#4e9a06">&#34;postal_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;04524&#34;</span>,
              <span style="color:#4e9a06">&#34;location&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#4e9a06">&#34;lat&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 37.5794,
            <span style="color:#4e9a06">&#34;lon&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 126.9754
        <span style="color:#ce5c00;font-weight:bold">}</span>,
         <span style="color:#4e9a06">&#34;country_code2&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;KR&#34;</span>,
           <span style="color:#4e9a06">&#34;region_code&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;11&#34;</span>,
              <span style="color:#4e9a06">&#34;latitude&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 37.5794,
              <span style="color:#4e9a06">&#34;timezone&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Asia/Seoul&#34;</span>,
           <span style="color:#4e9a06">&#34;region_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Seoul&#34;</span>,
         <span style="color:#4e9a06">&#34;country_code3&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;KR&#34;</span>,
             <span style="color:#4e9a06">&#34;city_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;Seoul&#34;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>,
           <span style="color:#4e9a06">&#34;auth&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;-&#34;</span>,
       <span style="color:#4e9a06">&#34;response&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;503&#34;</span>,
        <span style="color:#4e9a06">&#34;logdate&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 2022-01-09T08:52:49.000Z,
    <span style="color:#4e9a06">&#34;httpversion&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;1.1&#34;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><br>
<br>
<p>지금까지 logstash 가 network 에서 읽어들인 데이터를 filter 처리를하고 output 으로 console 에 출력하는 예시를 봤습니다.</p>
<p>예시에 사용된 모든 exam_*.ls 파일들은 pipelines.yml 에서 인식할 수 있는 경로에 두면 logstash 서비스가 실행하게 됩니다.</p>
<p>다음은 테스트에 사용된 nc명령이 아닌 filebeat 가 읽어들인 파일을 logstash 로 전송하는 설명을 하겠습니다.</p>
<br>
<h4 id="filebeat-설치">filebeat 설치</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ yum list filebeat
</code></pre></div><h4 id="filebeat-설정">filebeat 설정</h4>
<p>filebeat 와 elasticsearch 의 관계를 설명하는 다이어그램입니다.</p>
<p>filebeat의 주요 기능은 는 로그파일을 읽어들이고(<code>input</code>) elasticsearch 혹은 logstash 로 출력(<code>output</code>)하는 것입니다.</p>
<img src="/images/system/20220126-ELK-basic.png" width="600">
<p><a href="/images/system/20220126-ELK-basic.png" target="_blank">새 창 보기</a></p>
<br>
<br>
<p>filebeat 설정 파일<code>/etc/filebeat/filebeat.yml</code>에 기본 설정된 상태를 보면 <code>output.elasticsearch</code> 가 활성화 되어있고, <code>output.logstash</code>는  비활성화로 되어있습니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#0000cf;font-weight:bold">132</span> output.elasticsearch:
<span style="color:#0000cf;font-weight:bold">133</span>   <span style="color:#8f5902;font-style:italic"># Array of hosts to connect to.</span>
<span style="color:#0000cf;font-weight:bold">134</span>   hosts: <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;localhost:9200&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
...
<span style="color:#0000cf;font-weight:bold">145</span> <span style="color:#8f5902;font-style:italic">#output.logstash:</span>
<span style="color:#0000cf;font-weight:bold">146</span>   <span style="color:#8f5902;font-style:italic"># The Logstash hosts</span>
<span style="color:#0000cf;font-weight:bold">147</span>   <span style="color:#8f5902;font-style:italic">#hosts: [&#34;localhost:5044&#34;]</span>
</code></pre></div><p>filebeat는 <code>filebeat &gt; logstash &gt; elasticsearch</code> 혹은 <code>filebeat &gt; elasticsearch</code> 형태로 구성할 수 있습니다.</p>
<p>elasticsearch 에 전송하는 것이 목적이지만 테스트를 위해 logstash 에서 stdout 으로 원하는 포맷으로 logstash-filter 처리가 되었는지를 확인할 때 사용할 수 있습니다.</p>
<br>
<p>filebeat 를 yum 으로 설치했을 경우 systemd 에 추가할 수 있습니다.</p>
<p>기본적인 운용 개념은 다음과 같습니다.</p>
<ul>
<li>filebeat 서비스 실행</li>
<li>filebeat 설정 변경 및 모듈 추가</li>
<li>filebeat 서비스 재시작</li>
<li>kibana 에서 filebeat 가 elasticsearch 로 출력(<code>output</code>)한 내용 확인</li>
<li>filebeat 모듈 설정 (예: 활성화 상태 변경)</li>
<li>filebeat 서비스 재시작으로 모듈 설정된 내용 반영</li>
</ul>
<p>주요 내용은 설정을 변경하면 filebeat 서비스를 재시작해야 반영된다는 사항이 있습니다.</p>
<br>
<p>filebeat 가 읽어들일 로그파일이 잘 알려진 프로그램의 로그일 경우 modules 에 포함 되어있습니다.</p>
<p>그 중 apache 모듈에 access_log 를 읽어들이도록 모듈을 설정하고 활성화하는 예시입니다.</p>
<p>(활성화된 모듈 목록을 확인하고 apache 모듈을 enable 해봅니다.)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ filebeat modules list
Enabled:

Disabled:
activemq
apache
auditd
...
$ 
$ filebeat modules <span style="color:#204a87">enable</span> apache
Enabled apache
$ 
$ filebeat modules list
Enabled:
apache

Disabled:
activemq
auditd
$ 
</code></pre></div><p>filebeat 의 module 설정은 아래 경로에 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ls /etc/filebeat/modules.d/
activemq.yml.disabled     cylance.yml.disabled           iptables.yml.disabled         o365.yml.disabled        sophos.yml.disabled
apache.yml                elasticsearch.yml.disabled     juniper.yml.disabled          okta.yml.disabled        squid.yml.disabled
auditd.yml.disabled       envoyproxy.yml.disabled        kafka.yml.disabled            oracle.yml.disabled      suricata.yml.disabled
aws.yml.disabled          f5.yml.disabled                kibana.yml.disabled           osquery.yml.disabled     system.yml.disabled
awsfargate.yml.disabled   fortinet.yml.disabled          logstash.yml.disabled         panw.yml.disabled        threatintel.yml.disabled
azure.yml.disabled        gcp.yml.disabled               microsoft.yml.disabled        pensando.yml.disabled    tomcat.yml.disabled
barracuda.yml.disabled    google_workspace.yml.disabled  misp.yml.disabled             postgresql.yml.disabled  traefik.yml.disabled
bluecoat.yml.disabled     googlecloud.yml.disabled       mongodb.yml.disabled          proofpoint.yml.disabled  zeek.yml.disabled
cef.yml.disabled          gsuite.yml.disabled            mssql.yml.disabled            rabbitmq.yml.disabled    zookeeper.yml.disabled
checkpoint.yml.disabled   haproxy.yml.disabled           mysql.yml.disabled            radware.yml.disabled     zoom.yml.disabled
cisco.yml.disabled        ibmmq.yml.disabled             mysqlenterprise.yml.disabled  redis.yml.disabled       zscaler.yml.disabled
coredns.yml.disabled      icinga.yml.disabled            nats.yml.disabled             santa.yml.disabled
crowdstrike.yml.disabled  iis.yml.disabled               netflow.yml.disabled          snort.yml.disabled
cyberark.yml.disabled     imperva.yml.disabled           netscout.yml.disabled         snyk.yml.disabled
cyberarkpas.yml.disabled  infoblox.yml.disabled          nginx.yml.disabled            sonicwall.yml.disabled
$ 
$ ls -al /etc/filebeat/modules.d/apache.yml
-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">476</span> 2022-01-07 09:36 /etc/filebeat/modules.d/apache.yml
</code></pre></div><p><code>apache.yml</code>에 access_log, error_log 를 수집할 수 있도록 설정합니다.</p>
<p>설정 전 확인할 사항</p>
<ul>
<li>access_log 경로: (예) <code>/outlog/WEB/httpd/nexus_ssl-access.log.2022-01-26</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">- module: apache
  access:
    enabled: <span style="color:#204a87">true</span>
    input:
      fields:
        server_name: develop-httpd
        log_type: nexus_access
    var.paths: <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;/outlog/WEB/httpd/nexus_ssl-access.log.*&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>

  error:
    enabled: <span style="color:#204a87">true</span>
    <span style="color:#8f5902;font-style:italic">#var.paths: []</span>
</code></pre></div><p><code>filebeat modules enable apache</code> 명령으로 모듈을 활성화 상태로 설정합니다.</p>
<p><code>systemctl restart filebeat</code> 명령으로 서비스를 재시작합니다.</p>
<p>아래와 같이 kibana 에서 access_log 를 확인합니다.</p>
<img src="/images/system/20220126-kibana_basic.png" width="600">
<p><a href="/images/system/20220126-kibana_basic.png" target="_blank">새 창 보기</a></p>
<br>
<br>
<h4 id="filebeat-이해-filebeat-logstash-elastic">filebeat 이해 (filebeat-logstash-elastic)</h4>
<h5 id="logstash-설정-1">logstash 설정</h5>
<p><code>filebeat-elastic</code> 구성을 <code>filebeat-logstash-elastic</code> 으로 변경하여 apache 로그를 수집하는 예시입니다.</p>
<p>logstash 에 filebeat 를 수신하기 위한 pipeline(<code>exam_filebeat.conf</code>)을 하나 추가합니다.</p>
<p>테스트를 단계별로 진행하기 위해 output 은 stdout 만 남기고 주석처리를 합니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ cat &lt;&lt; EOF &gt; /etc/logstash/conf.d/exam_filebeat.conf
input {
  # exam_tcp.conf 는 tcp 소캣으로 읽어들이도록 설정되어 있습니다.
  #tcp {
  #  port =&gt; 10000
  #}
  # exam_filebeat.conf 는 filebeat 에서 읽어들이도록 설정합니다.
  beats {
    port =&gt; 11000
  }
}

filter {
  mutate {
    remove_field =&gt; [&#34;agent&#34;]
  }
  grok {
    match =&gt; { &#34;message&#34; =&gt; &#34;%{COMBINEDAPACHELOG}&#34; }
  }
  geoip {
    source =&gt; &#34;clientip&#34;
  }
  mutate {
    convert =&gt; {
      &#34;bytes&#34; =&gt; &#34;integer&#34;
    }
  }
  useragent {
    source =&gt; &#34;agent&#34;
    target =&gt; &#34;useragent&#34;
  }
  date {
    match =&gt; [&#34;timestamp&#34;, &#34;dd/MMM/yyyy:HH:mm:ss Z&#34;]
  }
  mutate {
    remove_field =&gt; [&#34;timestamp&#34;, &#34;host&#34;, &#34;@version&#34;, &#34;agent&#34;]
  }
}

output {
  stdout {
    # 대량 데이터일 경우 1건당 .으로 표시되도록 설정
    #codec =&gt; &#34;dots&#34;
  }
  #elasticsearch {
  #  # 로그발생 일자(timestamp)별로 elasticsearch 에 생성되는 index가 을 rolling 되도록 설정
  #  # 의 값으로 %{+yyyy.MM.dd} 포맷의 index가 일자별로 생성됨
  #  index =&gt; &#34;mgkim-apache-log-%{+yyyy.MM.dd}&#34;
  #  # elasticsearch 에 전송시 id/pw 정보가 필요합니다.
  #  # security 미적용 시 평문으로된 &#34;votmdnjem&#34; 를 입력
  #  hosts =&gt; [&#34;localhost:8200&#34;]
  #  user =&gt; &#34;elastic&#34;
  #  password =&gt; &#34;votmdnjem&#34;
  #}
}
EOF
$ 
</code></pre></div><p>logstash 에 pipeline(<code>exam_filebeat.conf</code>) 추가 후 정상적으로 시작된 로그를 확인합니다.</p>
<p><code>tail -f /outlog/PROD/logstash/logstash-plain.log</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">[2022-01-28T17:02:00,967][INFO ][logstash.javapipeline    ][main] Starting pipeline {:pipeline_id=&gt;&#34;main&#34;, &#34;pipeline.workers&#34;=&gt;4, &#34;pipeline.batch.size&#34;=&gt;125, &#34;pipeline.batch.delay&#34;=&gt;50, &#34;pipeline.max_inflight&#34;=&gt;500, &#34;pipeline.sources&#34;=&gt;[&#34;/etc/logstash/conf.d/exam_filebeat.conf&#34;, &#34;/etc/logstash/conf.d/exam_tcp.conf&#34;], :thread=&gt;&#34;#&lt;Thread:0x1625cd85 run&gt;&#34;}
[2022-01-28T17:02:01,912][INFO ][logstash.javapipeline    ][main] Pipeline Java execution initialization time {&#34;seconds&#34;=&gt;0.94}
[2022-01-28T17:02:01,937][INFO ][logstash.inputs.beats    ][main] Starting input listener {:address=&gt;&#34;0.0.0.0:11000&#34;}
[2022-01-28T17:02:02,118][INFO ][logstash.javapipeline    ][main] Pipeline started {&#34;pipeline.id&#34;=&gt;&#34;main&#34;}
[2022-01-28T17:02:02,133][INFO ][logstash.inputs.tcp      ][main][71e68810c5b50adf6cf53d1923400c9bc4a6e144d1df3de0b7607e41a062c940] Starting tcp input listener {:address=&gt;&#34;0.0.0.0:10000&#34;, :ssl_enable=&gt;false}
[2022-01-28T17:02:02,219][INFO ][org.logstash.beats.Server][main][cfcaf5386821113b776dd2ed8e280ac14652eefa6917b906e2915cdb2ac8904c] Starting server on port: 11000
[2022-01-28T17:02:02,265][INFO ][logstash.agent           ] Pipelines running {:count=&gt;1, :running_pipelines=&gt;[:main], :non_running_pipelines=&gt;[]}
</code></pre></div><br>
<h5 id="filebeat-설정-1">filebeat 설정</h5>
<p>filebeat 서비스를 활성화합니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ systemctl <span style="color:#204a87">enable</span> filebeat.service 
Synchronizing state of filebeat.service with SysV service script with /usr/lib/systemd/systemd-sysv-install.
Executing: /usr/lib/systemd/systemd-sysv-install <span style="color:#204a87">enable</span> filebeat
Created symlink /etc/systemd/system/multi-user.target.wants/filebeat.service → /usr/lib/systemd/system/filebeat.service.
$ 
</code></pre></div><br>
<p>filebeat 서비스 파일<code>/usr/lib/systemd/system/filebeat.service</code>에서 로그 디렉토리와 데이터 디렉토리를 변경합니다.</p>
<p>(systemd 서비스 파일을 수정하면 <code>systemctl daemon-reload</code> 실행해야 반영됩니다.)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ vi /usr/lib/systemd/system/filebeat.service
  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">[</span>Unit<span style="color:#ce5c00;font-weight:bold">]</span>
  <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000">Description</span><span style="color:#ce5c00;font-weight:bold">=</span>Filebeat sends log files to Logstash or directly to Elasticsearch.
  <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000">Documentation</span><span style="color:#ce5c00;font-weight:bold">=</span>https://www.elastic.co/beats/filebeat
  <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000">Wants</span><span style="color:#ce5c00;font-weight:bold">=</span>network-online.target
  <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#000">After</span><span style="color:#ce5c00;font-weight:bold">=</span>network-online.target
  <span style="color:#0000cf;font-weight:bold">6</span> 
  <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#ce5c00;font-weight:bold">[</span>Service<span style="color:#ce5c00;font-weight:bold">]</span>
  <span style="color:#0000cf;font-weight:bold">8</span> 
  <span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GODEBUG=&#39;madvdontneed=1&#39;&#34;</span>
 <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;BEAT_LOG_OPTS=&#34;</span>
 <span style="color:#0000cf;font-weight:bold">11</span> <span style="color:#000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;BEAT_CONFIG_OPTS=-c /etc/filebeat/filebeat.yml&#34;</span>
 <span style="color:#0000cf;font-weight:bold">12</span> <span style="color:#8f5902;font-style:italic">#Environment=&#34;BEAT_PATH_OPTS=--path.home /usr/share/filebeat --path.config /etc/filebeat --path.data /var/lib/filebeat --path.logs /var/log/filebeat&#34;</span>
 <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;BEAT_PATH_OPTS=--path.home /usr/share/filebeat --path.config /etc/filebeat --path.data /data/PROD/filebeat --path.logs /outlog/PROD/filebeat&#34;</span>
 <span style="color:#0000cf;font-weight:bold">14</span> <span style="color:#000">ExecStart</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/share/filebeat/bin/filebeat --environment systemd <span style="color:#000">$BEAT_LOG_OPTS</span> <span style="color:#000">$BEAT_CONFIG_OPTS</span> <span style="color:#000">$BEAT_PATH_OPTS</span>
 <span style="color:#0000cf;font-weight:bold">15</span> <span style="color:#000">Restart</span><span style="color:#ce5c00;font-weight:bold">=</span>always
 <span style="color:#0000cf;font-weight:bold">16</span> 
 <span style="color:#0000cf;font-weight:bold">17</span> <span style="color:#ce5c00;font-weight:bold">[</span>Install<span style="color:#ce5c00;font-weight:bold">]</span>
 <span style="color:#0000cf;font-weight:bold">18</span> <span style="color:#000">WantedBy</span><span style="color:#ce5c00;font-weight:bold">=</span>multi-user.target
$ systemctl daemon-reload
$ mkdir -p /data/PROD/filebeat
$ mkdir -p /outlog/PROD/filebeat
</code></pre></div><br>
<p>filebeat 의 output 을 logstash 로 되도록 수정합니다.</p>
<p>설정파일<code>/etc/filebeat/filebeat.yml</code>에서 <code>output.elasticsearch</code> 를 주석처리하고, <code>output.logstash</code> 를 주석해제 합니다.</p>
<p>테스트의 단순화를 위해 filebeat module 이 enable 된 것들을 모두 disable 로 변경합니다.</p>
<p><code>filebeat modules disable apache</code></p>
<p>filebeat 가 읽어들일 테스트용 apache access 로그파일<code>/root/test/weblog.txt</code>을 설정합니다.</p>
<p>weblog.txt 파일: <a href="/files/system/20220128-weblog.txt" download="weblog.txt">다운로드</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ vi /etc/filebeat/filebeat.yml
<span style="color:#8f5902;font-style:italic">#- type: filestream</span>
- type: log
  enabled: <span style="color:#204a87">true</span>
    - /root/ls-test/weblog.txt
<span style="color:#8f5902;font-style:italic">#output.elasticsearch:</span>
  <span style="color:#8f5902;font-style:italic">#hosts: [&#34;localhost:9200&#34;]</span>
output.logstash:
  hosts: <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;localhost:11000&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</code></pre></div><br>
<h5 id="filebeat-logstash-테스트">filebeat-logstash 테스트</h5>
<ol>
<li>
<p>logstash 서비스의 startup 로그에서 pipeline 이 정상적으로 설정되었는지 확인</p>
<p><code>tail -f /outlog/PROD/logstash/logstash-plain.log</code>
<br>
<br></p>
</li>
<li>
<p>logstash 의 console 로그를 보기위해 실행</p>
<p><code>tail -f /var/log/messages | grep logstash</code> 
<br>
<br></p>
</li>
<li>
<p>filebeat 의 console 로그를 보기위해 실행</p>
<p><code>tail -f /var/log/messages | grep filebeat</code> 
<br>
<br></p>
</li>
<li>
<p>filebeat 서비스를 실행하기 전에 데이터 디렉토리 하위 파일 삭제</p>
<p>filebeat 가 읽어들인 정보는 /data/PROD/filebeat 에 보관되어 있으며 하위 파일을 삭제하면 filebeat 서비스가 재시작할때 다시 읽어들입니다.</p>
<p><code>rm -rf /data/PROD/filebeat/*</code>
<br>
<br></p>
</li>
<li>
<p>logstash 서비스 시작</p>
<p><code>systemctl restart logstash.service</code>
<br>
<br></p>
</li>
<li>
<p>테스트 로그 파일 확인</p>
<p>테스트용으로 1건만 추가되어있는 파일이 준비되어 있는지 확인합니다.</p>
<p><code>vi /root/ls-test/weblog.txt</code>
<br>
<br></p>
</li>
<li>
<p>filebeat 서비스 시작</p>
<p><code>systemctl restart filebeat.service</code>
<br>
<br></p>
</li>
<li>
<p>결과 확인</p>
<p>filebeat 서비스 시작으로 logstash 처리까지 되었는지 확인합니다.</p>
<p>아래는 정상처리가 되었을 경우 출력되는 로그 입니다.</p>
<p>로그: <a href="/files/system/20220128-filebeat-logstash_test_log.txt" target="_blank">새 창 보기</a></p>
</li>
</ol>
<br>
<h5 id="filebeat-logstash-elastics-테스트">filebeat-logstash-elastics 테스트</h5>
<ol>
<li>
<p>filebeat 와 logstash 서비스를 모두 stop 합니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ systemctl stop filebeat.service 
$ systemctl stop logstash.service 
</code></pre></div><br>
</li>
<li>
<p>logstash pipeline 설정파일 output 에 elasticsearch 가 주석처리된 부분 해제</p>
<p>pipeline 설정파일: <code>/etc/logstash/conf.d/exam_filebeat.conf</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">...
output {
  stdout {
    # 대량 데이터일 경우 1건당 .으로 표시되도록 설정
    #codec =&gt; &#34;dots&#34;
  }
  elasticsearch {
    # 로그발생 일자(timestamp)별로 elasticsearch 에 생성되는 index가 을 rolling 되도록 설정
    # 의 값으로 %{+yyyy.MM.dd} 포맷의 index가 일자별로 생성됨
    index =&gt; &#34;mgkim-apache-log-%{+yyyy.MM.dd}&#34;
    # elasticsearch 에 전송시 id/pw 정보가 필요합니다.
    # security 미적용 시 평문으로된 &#34;votmdnjem&#34; 를 입력
    hosts =&gt; [&#34;localhost:8200&#34;]
    user =&gt; &#34;elastic&#34;
    password =&gt; &#34;votmdnjem&#34;
  }
}
</code></pre></div><br>
</li>
<li>
<p>logstash 서비스 및 filebeat 서비스 시작</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ systemctl start logstash.service 
$ systemctl start filebeat.service 
</code></pre></div><p>logstash startup 로그: <a href="/files/system/20220128-logstash_startup_log.txt" target="_blank">새 창 보기</a></p>
<p>(logstash pipeline 에 정의된 elasticsearch 접속정보로 정상 연결되었는지 확인)
<br></p>
</li>
<li>
<p>elasticsearch 에서 처리결과 확인</p>
<p>elasticsearch 에서 logstash 가 보낸 데이터로 생성된 index 를 조회</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ curl -XGET -u elastic:votmdnjem &#34;http://localhost:8200/_cat/indices?pretty&amp;v&amp;s=index:desc
</code></pre></div><p>조회 결과 index 명은 logstash 의 pipeline 에 설정된 값으로 확인합니다.</p>
<p>pipeline 설정파일: <code>/etc/logstash/conf.d/exam_filebeat.conf</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">elasticsearch {
  index =&gt; &#34;mgkim-apache-log-%{+yyyy.MM.dd}&#34;
}
</code></pre></div><p>elasticsearch 에서 index 명 <code>mgkim-apache-log-2022.01.09</code> 의 데이터 조회</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ curl -XGET -u elastic:votmdnjem &#34;http://localhost:8200/mgkim-apache-log-2022.01.09/_search?pretty&#34;
</code></pre></div><p>curl 테스트: <a href="/files/system/20220128-filebeat-logstash-elastic_test.txt" target="_blank">새 창 보기</a>
<br></p>
</li>
</ol>
<h5 id="logstash-설정-keystore">logstash 설정 (keystore)</h5>
<p>logstash 의 pipeline 설정 파일에 elasticsearch 패스워드 입력부분을 keystore 에서 가져오도록 할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">elasticsearch {
  hosts =&gt; [&#34;localhost:8200&#34;]
  user =&gt; &#34;elastic&#34;
  #password =&gt; &#34;votmdnjem&#34;
  # logstash-keystore 에서 es_password 값을 사용하도록 함
  password =&gt; &#34;${es_password}&#34;
}
</code></pre></div><p>logstash 에서 keystore 를 생성하는 과정입니다.</p>
<p>신경써야하는 부분은 keystore 의 password 를 저장하는 시스템변수 <code>LOGSTASH_KEYSTORE_PASS</code> 와 logstash 서비스의 설정과 관련있는 <code>--path.settings</code> 파라미터의 경로입니다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#8f5902;font-style:italic">### logstash 서비스 파일에서 EnvironmentFile 파일 확인</span>
<span style="color:#8f5902;font-style:italic">### EnvironmentFile 파일에 LOGSTASH_KEYSTORE_PASS 변수 추가할 목적으로 확인</span>
<span style="color:#8f5902;font-style:italic">### --path.settings 의 경로를 확인 (logstash-keystore 로 keystore 생성 시 파라미터로 전달해야함)</span>
$ cat /etc/systemd/system/logstash.service
<span style="color:#ce5c00;font-weight:bold">[</span>Unit<span style="color:#ce5c00;font-weight:bold">]</span>
<span style="color:#000">Description</span><span style="color:#ce5c00;font-weight:bold">=</span>logstash

<span style="color:#ce5c00;font-weight:bold">[</span>Service<span style="color:#ce5c00;font-weight:bold">]</span>
<span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">=</span>simple
<span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">=</span>logstash
<span style="color:#000">Group</span><span style="color:#ce5c00;font-weight:bold">=</span>logstash
<span style="color:#8f5902;font-style:italic"># Load env vars from /etc/default/ and /etc/sysconfig/ if they exist.</span>
<span style="color:#8f5902;font-style:italic"># Prefixing the path with &#39;-&#39; makes it try to load, but if the file doesn&#39;t</span>
<span style="color:#8f5902;font-style:italic"># exist, it continues onward.</span>
<span style="color:#000">EnvironmentFile</span><span style="color:#ce5c00;font-weight:bold">=</span>-/etc/default/logstash
<span style="color:#000">EnvironmentFile</span><span style="color:#ce5c00;font-weight:bold">=</span>-/etc/sysconfig/logstash
<span style="color:#000">ExecStart</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/share/logstash/bin/logstash <span style="color:#4e9a06">&#34;--path.settings&#34;</span> <span style="color:#4e9a06">&#34;/etc/logstash&#34;</span>
<span style="color:#000">Restart</span><span style="color:#ce5c00;font-weight:bold">=</span>always
<span style="color:#000">WorkingDirectory</span><span style="color:#ce5c00;font-weight:bold">=</span>/
<span style="color:#000">Nice</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">19</span>
<span style="color:#000">LimitNOFILE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16384</span>

<span style="color:#8f5902;font-style:italic"># When stopping, how long to wait before giving up and sending SIGKILL?</span>
<span style="color:#8f5902;font-style:italic"># Keep in mind that SIGKILL on a process can cause data loss.</span>
<span style="color:#000">TimeoutStopSec</span><span style="color:#ce5c00;font-weight:bold">=</span>infinity

<span style="color:#ce5c00;font-weight:bold">[</span>Install<span style="color:#ce5c00;font-weight:bold">]</span>
<span style="color:#000">WantedBy</span><span style="color:#ce5c00;font-weight:bold">=</span>multi-user.target




<span style="color:#8f5902;font-style:italic">### EnvironmentFile 파일의 마지막 부분에 LOGSTASH_KEYSTORE_PASS=1 추가</span>
<span style="color:#8f5902;font-style:italic">### logstash 서비스가 logstash-keystore 에 접근할 때 사용합니다.</span>
$ cat /etc/default/logstash
<span style="color:#000">LS_HOME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/usr/share/logstash&#34;</span>
<span style="color:#000">LS_SETTINGS_DIR</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/etc/logstash&#34;</span>
<span style="color:#000">LS_PIDFILE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/var/run/logstash.pid&#34;</span>
<span style="color:#000">LS_USER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;logstash&#34;</span>
<span style="color:#000">LS_GROUP</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;logstash&#34;</span>
<span style="color:#000">LS_GC_LOG_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/var/log/logstash/gc.log&#34;</span>
<span style="color:#000">LS_OPEN_FILES</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;16384&#34;</span>
<span style="color:#000">LS_NICE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;19&#34;</span>
<span style="color:#000">SERVICE_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;logstash&#34;</span>
<span style="color:#000">SERVICE_DESCRIPTION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;logstash&#34;</span>

<span style="color:#000">LOGSTASH_KEYSTORE_PASS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>




<span style="color:#8f5902;font-style:italic">### key 저장소 생성</span>
$ /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash create
Using JAVA_HOME defined java: /prod/java/openjdk-11.0.13.8-temurin
WARNING: Using JAVA_HOME <span style="color:#204a87;font-weight:bold">while</span> Logstash distribution comes with a bundled JDK.
DEPRECATION: The use of JAVA_HOME is now deprecated and will be removed starting from 8.0. Please configure LS_JAVA_HOME instead.
OpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.

Created Logstash keystore at /etc/logstash/logstash.keystore




<span style="color:#8f5902;font-style:italic">### key 저장소가 생성된 경로의 파일의 소유자를 logstash 로 변경</span>
$ chown logstash:root /etc/logstash/logstash.keystore
$ ls -al /etc/logstash/logstash.keystore
-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> logstash root <span style="color:#0000cf;font-weight:bold">771</span> 2022-01-28 16:55 /etc/logstash/logstash.keystore




<span style="color:#8f5902;font-style:italic">### key 저장소에 es_password 추가</span>
$ /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash add es_password
Using JAVA_HOME defined java: /prod/java/openjdk-11.0.13.8-temurin
WARNING: Using JAVA_HOME <span style="color:#204a87;font-weight:bold">while</span> Logstash distribution comes with a bundled JDK.
DEPRECATION: The use of JAVA_HOME is now deprecated and will be removed starting from 8.0. Please configure LS_JAVA_HOME instead.
OpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.

Enter value <span style="color:#204a87;font-weight:bold">for</span> es_password: 
Added <span style="color:#4e9a06">&#39;es_password&#39;</span> to the Logstash keystore.




<span style="color:#8f5902;font-style:italic">### key 저장소에 es_password 가 있는지 확인</span>
$ /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash list
Using JAVA_HOME defined java: /prod/java/openjdk-11.0.13.8-temurin
WARNING: Using JAVA_HOME <span style="color:#204a87;font-weight:bold">while</span> Logstash distribution comes with a bundled JDK.
DEPRECATION: The use of JAVA_HOME is now deprecated and will be removed starting from 8.0. Please configure LS_JAVA_HOME instead.
OpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.

es_password




<span style="color:#8f5902;font-style:italic">### logstash 의 pipeline 설정 파일에 es_password 로 치환</span>
<span style="color:#8f5902;font-style:italic">### pipeline 설정파일: /etc/logstash/conf.d/exam_filebeat.conf</span>
...
elasticsearch <span style="color:#ce5c00;font-weight:bold">{</span>
  <span style="color:#000">hosts</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;localhost:8200&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
  <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;elastic&#34;</span>
  <span style="color:#8f5902;font-style:italic">#password =&gt; &#34;votmdnjem&#34;</span>
  <span style="color:#8f5902;font-style:italic"># logstash-keystore 에서 es_password 값을 사용하도록 함</span>
  <span style="color:#000">password</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">es_password</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
...



<span style="color:#8f5902;font-style:italic">### logstash 서비스 재시작 후 elasticsearch 접속 상태 로그에서 확인</span>
$ systemctl restart logstash
$ tail -f /var/log/messages <span style="color:#000;font-weight:bold">|</span> grep logstash
Jan <span style="color:#0000cf;font-weight:bold">28</span> 21:34:53 centos8 logstash<span style="color:#ce5c00;font-weight:bold">[</span>100495<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#ce5c00;font-weight:bold">[</span>2022-01-28T21:34:53,467<span style="color:#ce5c00;font-weight:bold">][</span>INFO <span style="color:#ce5c00;font-weight:bold">][</span>logstash.outputs.elasticsearch<span style="color:#ce5c00;font-weight:bold">][</span>main<span style="color:#ce5c00;font-weight:bold">]</span> New Elasticsearch output <span style="color:#ce5c00;font-weight:bold">{</span>:class<span style="color:#ce5c00;font-weight:bold">=</span>&gt;<span style="color:#4e9a06">&#34;LogStash::Outputs::ElasticSearch&#34;</span>, :hosts<span style="color:#ce5c00;font-weight:bold">=</span>&gt;<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;//localhost:8200&#34;</span><span style="color:#ce5c00;font-weight:bold">]}</span>
Jan <span style="color:#0000cf;font-weight:bold">28</span> 21:34:53 centos8 logstash<span style="color:#ce5c00;font-weight:bold">[</span>100495<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#ce5c00;font-weight:bold">[</span>2022-01-28T21:34:53,791<span style="color:#ce5c00;font-weight:bold">][</span>INFO <span style="color:#ce5c00;font-weight:bold">][</span>logstash.outputs.elasticsearch<span style="color:#ce5c00;font-weight:bold">][</span>main<span style="color:#ce5c00;font-weight:bold">]</span> Elasticsearch pool URLs updated <span style="color:#ce5c00;font-weight:bold">{</span>:changes<span style="color:#ce5c00;font-weight:bold">=</span>&gt;<span style="color:#ce5c00;font-weight:bold">{</span>:removed<span style="color:#ce5c00;font-weight:bold">=</span>&gt;<span style="color:#ce5c00;font-weight:bold">[]</span>, :added<span style="color:#ce5c00;font-weight:bold">=</span>&gt;<span style="color:#ce5c00;font-weight:bold">[</span>http://elastic:xxxxxx@localhost:8200/<span style="color:#ce5c00;font-weight:bold">]}}</span>
Jan <span style="color:#0000cf;font-weight:bold">28</span> 21:34:54 centos8 logstash<span style="color:#ce5c00;font-weight:bold">[</span>100495<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#ce5c00;font-weight:bold">[</span>2022-01-28T21:34:54,027<span style="color:#ce5c00;font-weight:bold">][</span>WARN <span style="color:#ce5c00;font-weight:bold">][</span>logstash.outputs.elasticsearch<span style="color:#ce5c00;font-weight:bold">][</span>main<span style="color:#ce5c00;font-weight:bold">]</span> Restored connection to ES instance <span style="color:#ce5c00;font-weight:bold">{</span>:url<span style="color:#ce5c00;font-weight:bold">=</span>&gt;<span style="color:#4e9a06">&#34;http://elastic:xxxxxx@localhost:8200/&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
Jan <span style="color:#0000cf;font-weight:bold">28</span> 21:34:54 centos8 logstash<span style="color:#ce5c00;font-weight:bold">[</span>100495<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#ce5c00;font-weight:bold">[</span>2022-01-28T21:34:54,044<span style="color:#ce5c00;font-weight:bold">][</span>INFO <span style="color:#ce5c00;font-weight:bold">][</span>logstash.outputs.elasticsearch<span style="color:#ce5c00;font-weight:bold">][</span>main<span style="color:#ce5c00;font-weight:bold">]</span> Elasticsearch version determined <span style="color:#ce5c00;font-weight:bold">(</span>7.16.3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>:es_version<span style="color:#ce5c00;font-weight:bold">=</span>&gt;7<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
	
	
	<div class="text-muted mt-5 pt-3 border-top">

</div>

</div>


          </main>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>


<script src="https://cdn.jsdelivr.net/npm/mermaid@8.11.2/dist/mermaid.min.js" integrity="sha384-m8Pdaep6Qk8sW3J6XhPOiwUww3maU9HxZTLvEfSEB4e1UVvTdHyfJsYmEfYqvwLC" crossorigin="anonymous"></script>



<style>
.markmap > svg {
  width: 100%;
  height: 300px;
}
</style>
<script>
window.markmap = {
  autoLoader: { manual: true },
};
</script>
<script src="https://cdn.jsdelivr.net/npm/markmap-autoloader"></script>


<script src='/js/tabpane-persist.js'></script>



<script src='/js/deflate.js'></script>


 

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.min.css" integrity="sha384-Cqd8ihRLum0CCg8rz0hYKPoLZ3uw+gES2rXQXycqnL5pgVQIflxAUDS7ZSjITLb5" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.min.js" integrity="sha384-1Or6BdeNQb0ezrmtGeqQHFpppNd7a/gw29xeiSikBbsb44xu3uAo8c7FwbF5jhbd" crossorigin="anonymous"></script>
 


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/contrib/mhchem.min.js" integrity="sha384-LIgAiYlGSAdpNC9+YDjDPF6JeS/RRIumtNo0CmyQERZ/+g0h9MbuYQwf/5pQ4Y4M"  crossorigin="anonymous"></script>


<script defer src='https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/contrib/auto-render.min.js' integrity='sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl' crossorigin='anonymous' onload='renderMathInElement(document.body, null);'></script>














<script src="/js/main.min.c1b8f3c373b85f900699a7ea81c2038ebbbebcac1a5a4b6e5ef96c24c31790d6.js" integrity="sha256-wbjzw3O4X5AGmafqgcIDjru&#43;vKwaWktuXvlsJMMXkNY=" crossorigin="anonymous"></script>




  </body>
</html>